<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="Cache-Control" content="no-cache, no-store">
    <meta http-equiv="expires" content="0">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../../js/css/layui.css">
    <link rel="stylesheet" href="../../css/scroll.css">
    <link rel="stylesheet" href="../../js/zTree/css/zTreeStyle.css" type="text/css">
    <style>


        .search {
            height: 30px;
            border: 0px;
            /* padding-left: 5%;*/
            position: relative;
            text-align: center;
        }

        #templateName {
            background-color: #F2F3F5;
            border-radius: 4px 4px 4px 4px;
            height: 90%;
            width: 80%;
            display: inline-block;
            margin: 2px;
        }

        #templateName:hover {
            background-color: #FFFFFF;
            border: 1px solid #0094FF;
        }

        #menuName {
            background-color: #F2F3F5;
            border-radius: 4px 4px 4px 4px;
            height: 90%;
            width: 90%;
            display: inline-block;
            margin: 2px;
        }

        #menuName:hover {
            background-color: #FFFFFF;
            border: 1px solid #0094FF;
        }

        select {
            width: 80%;
            height: 30px;
            background-color: #F2F3F5;
            border: none;
            border-radius: 4px;
        }

        select:hover {
            background-color: #FFFFFF;
            border: 1px solid #0094FF;
        }

        .searchImg {
            position: absolute;
            right: 25%;
            top: 30%;
        }

        .option {
            height: 20px;
            line-height: 20px;
            display: flex;
            align-items: center;
            padding: 5px;
        }

        .optionCheck {
            margin-right: 10px;
            width: 20px;
            height: 20px;
        }

    </style>
    <script type="text/javascript" src="../../js/jquery-1.11.3.min.js"></script>
    <script type="text/javascript" src="../../js/zTree/js/jquery.ztree.all.min.js"></script>
    <script type="text/javascript" src="../../js/zTree/js/jquery.ztree.exhide.min.js"></script>
    <script type="text/javascript" src="../../js/layui.js" charset="utf-8"></script>

</head>
<body style="padding: 5px;height: 370px">
<!--选择 模板 名称-->
<div>
    <div id="menuDiv" style="width:90%;height:30px;display: flex;justify-content: center;padding:5px;">
        <div style="width: 40%;display: flex;justify-content: flex-end;align-items: center;padding-right: 10px;">
            选择要共享的用户
        </div>
        <div style="width:60%;display: flex;justify-content: flex-start;align-items: center;padding-left: 3px;">
            <select id="design">
            </select>
        </div>
    </div>
    <div style="width:90%;height:30px;padding:5px;display: flex;align-items: center;justify-content: center;">
        <div style="width: 40%;display: flex;justify-content: flex-end;padding-right: 10px;">
            选择要共享的模板
        </div>
        <div class="search" style="width: 60%;display: flex;justify-content: flex-start;display: flex;">
            <input type="text" id="templateName" placeholder="模板名称" autocomplete="off" class="layui-input">
            <input type="text" id="templateId" style="display: none;">
            <img src="../../images/design/searchTemplate.png" class="searchImg">
            <div id="tempDiv"
                 style="overflow-x:hidden;z-index:1000;position:absolute;width: 230px;height:300px;display: flex;align-items: center;justify-content: center;display: none;">
                <ul id="tempName" class="ztree"
                    style="overflow-x:hidden;padding:0px;width:100%;height:300px;white-space: nowrap;overflow: auto;background-color: #F2F3F5;">
                </ul>
            </div>
        </div>
    </div>

    <div id="menuDiv" style="width:90%;height:30px;display: flex;justify-content: center;padding:5px;">
        <div style="width: 40%;display: flex;justify-content: flex-end;align-items: center;padding-right: 10px;">
            是否可以修改模板
        </div>
        <div style="width:60%;display: flex;justify-content: flex-start;align-items: center;padding-left: 3px;">
            <select id="isEdit">
                <option value="0">否</option>
                <option value="1">是</option>
            </select>
        </div>
    </div>
</div>

</body>
<script type="text/javascript">
    var token = window.sessionStorage.getItem("cur_token");
    var ip = window.sessionStorage.getItem("ef_server_base_url");
    var url = ip + '/designSys/getCurUserTemplateZTree?token=' + token;
    var treeObj;
    var checkedTemplate = [];
    var checkedId = [];


    layui.use('layer', function () {
        var layer = layui.layer;
    });

    function showParent(treeNode, nodes, showList) { //递归显示所有父节点
        showList.push(treeNode.id);
        var parentNode = treeNode.getParentNode();
        if (parentNode == null) { //如果是根节点
            return;
        } else {
            if ($.inArray(parentNode.id, showList) != -1) {  //如果父节点已经显示
                treeObj.showNode(treeNode);//显示当前节点
            } else {
                showList.push(parentNode.id); //将父节点添加到显示结点列表
                treeObj.showNode(parentNode); //显示父节点
                treeObj.hideNodes(parentNode.children);//隐藏父节点的所有子节点
                treeObj.showNode(treeNode);//显示当前节点
                showParent(parentNode, null, showList); //遍历父亲结点
            }

        }
    }

    function initTemp(url, expand) {
        $.ajax({
            url: url,
            type: 'get',
            contentType: "application/json;charset=UTF-8",
            success: function (data) {
                var setting = {
                    view: {
                        showLine: false,
                        showIcon: false
                    },
                    data: {
                        simpleData: {
                            enable: true,
                            idKey: "id",
                            pIdKey: "pId"
                        }
                        , key: {
                            isParent: 'isParent'
                        }
                    },
                    check: {
                        checkType: 'checkbox',
                        enable: true
                    },
                    callback: {
                        onClick: function (event, id, node) {

                        },
                        onCheck: function (event, id, node) {
                            event.stopPropagation();
                            let checked = node.checked; //是否选中
                            let templateId = node.id;
                            let templateName = node.name;
                            let isParent = node.isParent;
                            if (isParent) { //目录节点，选中下面所有模板
                                if (checked) {
                                    processChildren(node);
                                } else {
                                    processUnCheckedChildren(node);
                                }

                            } else { //模板节点
                                if (checked) { //选中
                                    checkedTemplate.push(templateName);
                                    checkedId.push(templateId);
                                    let str = ''
                                    $.each(checkedTemplate, function (i, e) {
                                        if (i == checkedTemplate.length - 1) {
                                            str += e;
                                        } else {
                                            str += (e + ',');
                                        }
                                    })
                                    $('#templateName').val(str);
                                } else {
                                    $.each(checkedTemplate, function (i, e) {
                                        if (e == templateName) {
                                            let index = $.inArray(templateName, checkedTemplate); //根据元素值查找下标，不存在返回-1
                                            checkedTemplate.splice(index, 1);//根据下标删除一个元素   1表示删除一个元素
                                        }
                                    })
                                    let str = ''
                                    $.each(checkedTemplate, function (i, e) {
                                        if (i == checkedTemplate.length - 1) {
                                            str += e;
                                        } else {
                                            str += (e + ',');
                                        }
                                    })
                                    $('#templateName').val(str);
                                    $.each(checkedId, function (i, e) {
                                        if (e == templateId) {
                                            let index = $.inArray(templateId, checkedId); //根据元素值查找下标，不存在返回-1
                                            checkedId.splice(index, 1);//根据下标删除一个元素   1表示删除一个元素
                                        }
                                    })
                                }
                            }
                        }
                    }
                };
                treeObj = $.fn.zTree.init($("#tempName"), setting, data);
                treeObj.expandAll(true);

            }
        });
    }

    function initUser() {
        let url1 = ip + '/designSys/getDesignUser?token=' + token;
        $.ajax({
            url: url1,
            type: 'get',
            contentType: "application/json;charset=UTF-8",
            success: function (data) {
                let user = data.user; //获取所有用户
                $.each(user, function (i, e) {
                    $('#design').append('<option value="' + e.id + '">' + e.name + '</option>');
                })
            }
        });
    }

    //初始化数据链接
    function initDataSource() {
        let url1 = ip + '/designSys/getConnInfoByUser?token=' + token;
        $.ajax({
            url: url1,
            type: 'get',
            contentType: "application/json;charset=UTF-8",
            success: function (data) {
                let user = data.user; //获取所有用户
                $.each(user, function (i, e) {
                    $('#design').append('<option value="' + e.id + '">' + e.name + '</option>');
                })
            }
        });
    }

    function init() {
        initTemp(url);
        initUser();
        $('#templateName').unbind().bind('click', function (event) {
            event.stopPropagation();
            $('#tempDiv').css({
                left: 0,
                top: 30
            }).show();
        })

        $('body').click(function (event) {
            let id = $(event.target).attr("id");
            if (id != undefined && id.indexOf("temp") != -1) {

            } else {
                $('#tempDiv').hide();
            }
        });
    }

    function getDeleteIds() {
        if (checkedId.length == 0) {
            layer.msg('请选择模板');
            return;
        }
        if ($('#menuId').val() == '') {
            layer.msg('请选择目录');
            return;
        }
        let result = {}
        result.checkedId = checkedId;
        result.menuId = $('#menuId').val();
        return result;
    }

    function chooseAll(flag) {
        if (flag == 1) {
            treeObj.checkAllNodes(true);
            let nodes = treeObj.getCheckedNodes(true); //获取所有选中的结点
            checkedId = [];
            $.each(nodes, function (i, e) {
                checkedId.push(e.id);
            })
        } else {
            treeObj.checkAllNodes(false);
            checkedId = [];
        }
    }

    $(document).ready(function () {
        treeObj = $.fn.zTree.getZTreeObj("tree");

        $("#templateName").keyup(function (e) {
            var code = e.keyCode;
            if (code == 13) {
                var tempName = $("#templateName").val();
                if (treeObj) {
                    if (tempName == "") { //清空搜索框时
                        var allNode = treeObj.getNodes();
                        var nodes = treeObj.getNodesByParam("isHidden", true);
                        treeObj.showNodes(nodes);
                        //treeObj.showNodes(allNode);
                        treeObj.expandAll(true);
                    } else {
                        var nodes = treeObj.getNodesByParamFuzzy("name", tempName, null); //在树中模糊查询
                        if (nodes.length == 0) {
                            $("#tempName").blur();
                            layer.msg('目录不存在!', {
                                time: 1000, //1s后自动关闭
                                icon: 2
                            });
                        } else {
                            var allNode = treeObj.getNodes();
                            treeObj.hideNodes(allNode);
                            var showList = new Array();
                            var nodeList = new Array(); //当所有搜索的结点都不是末级结点时，需要重新显示所有数结点
                            $.each(nodes, function (index, element) {
                                treeObj.showNode(element);
                                showParent(element, nodes, showList);
                            });
                            if (nodeList.length == nodes.length) {
                                layer.alert('模板不存在');
                                var allNode = treeObj.getNodes();
                                treeObj.showNodes(allNode);
                                treeObj.expandAll(false);
                            } else {
                                treeObj.expandAll(true);
                            }
                        }
                    }
                }
            }
        });
    });


    function getShareInfos() {

        let userId = $('#design').val(); //被分享的用户ID
        let templateIds = checkedId; //被分享的模板ID
        let isEdit = $('#isEdit').val(); //是否可以修改模板

        let result = {
            userId: userId,
            templateIds: checkedId,
            isEdit: isEdit
        }

        return result;

    }


    //递归处理子结点
    function processChildren(node) {
        let children = node.children;
        //遍历模板结点
        $.each(children, function (i, e) {
            if (e.isParent) {
                processChildren(e)
            } else {
                let childName = e.name;
                let childId = e.id;
                checkedTemplate.push(childName);
                checkedId.push(childId);
                let str = ''
                $.each(checkedTemplate, function (i, e) {
                    if (i == checkedTemplate.length - 1) {
                        str += e;
                    } else {
                        str += (e + ',');
                    }
                })
                $('#templateName').val(str);
            }
        })
    }

    function processUnCheckedChildren(node) {
        let children = node.children;
        //遍历模板结点
        $.each(children, function (i, e) {
            if (e.isParent) { //遍历删除结点
                processUnCheckedChildren(e)
            } else {
                $.each(children, function (ii, ee) {
                    let templateName = ee.name; //模板名
                    let templateId = ee.id; //模板ID
                    $.each(checkedTemplate, function (i, e) {
                        if (e == templateName) {
                            let index = $.inArray(templateName, checkedTemplate); //根据元素值查找下标，不存在返回-1
                            checkedTemplate.splice(index, 1);//根据下标删除一个元素   1表示删除一个元素
                        }
                    })
                    let str = ''
                    $.each(checkedTemplate, function (i, e) {
                        if (i == checkedTemplate.length - 1) {
                            str += e;
                        } else {
                            str += (e + ',');
                        }
                    })
                    $('#templateName').val(str);
                    $.each(checkedId, function (i, e) {
                        if (e == templateId) {
                            let index = $.inArray(templateId, checkedId); //根据元素值查找下标，不存在返回-1
                            checkedId.splice(index, 1);//根据下标删除一个元素   1表示删除一个元素
                        }
                    })
                })

            }
        })
    }
</script>
</html>