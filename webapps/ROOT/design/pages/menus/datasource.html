<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="Cache-Control" content="no-cache, no-store">
    <meta http-equiv="expires" content="0">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link href="../../js/css/layui.css" rel="stylesheet">
    <style>
        html {
            width: 100%;
            height: 100%;
        }

        body {
            width: 100%;
            height: 100%;
        }

        #ds a {
            display: block;
            padding-left: 10px;
            line-height: 34px;
            max-height: 34px;
            font-size: 16px;
        }

        .ncka:hover {
            background: #e6e6e6;
        }

        .cka {
            background: #0094FF;
            color: #FFFFFF;
        }

        .cka:hover{
            background: #0094FF;
            color: #FFFFFF;
        }

        .add {
            width: 25px;
            height: 25px;
        }

        .delete {
            width: 25px;
            height: 25px;
        }

        .layui-form-select dl dd.layui-this {
            background-color: #0094FF;
            color: #fff;
        }

        .icon {
            display: inline-block;
            width: 33px;
            height: 22px;
            margin-top: 5px;
        }

        .icon-4 {
            background: url(../../images/design/eye.png) no-repeat 0 -43px;
            position: absolute;
            right: -10px;
            cursor: pointer;
        }

        .icon-5 {
            background: url(../../../imgs/icon-login.png) no-repeat -55px -43px;
        }

        input {
            background-color: #F2F3F5;
        }

        input:hover {
            border: 1px solid #44B4FF;
            background-color: #FFFFFF;
        }

        select {
            background-color: #F2F3F5;
        }

        select:hover {
            border: 1px solid #44B4FF;
            background-color: #FFFFFF;
        }

        .layui-input {
            background-color: #F2F3F5;
        }

        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        ::-webkit-scrollbar-thumb {
            border-radius: 10px;
            -webkit-box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2);
            background: #d5d5d5;
        }

    </style>
</head>
<body>
<div style="display:flex;width:100%;height:100%;">
    <div style="width: 30%;height: 100%;overflow: hidden;flex-direction: column;display: flex;">
        <div style="height:10%;display: flex;align-items: center;justify-content: center;">
            <div style="cursor:pointer;height:35px;width:100px;display: flex;background-color: #0094FF;border-radius: 4px;margin-right: 10px;"
                 id="add">
                <div style="width:50px;display: flex;justify-content: flex-end;align-items: center;padding-right: 5px;">
                    <img src="../../images/design/pages/add.png" style="" title="添加" class="add">
                </div>
                <div style="display:flex;align-items:center;color:white;width:50px;padding-left: 5px;">
                    新增
                </div>
            </div>
            <div style="cursor:pointer;height:35px;width:100px;display: flex;background-color: #FFFFFF;border-radius: 4px;border: 1px solid #F53F3F;"
                 id="del">
                <div style="display:flex;width:50px;justify-content: flex-end;align-items: center;padding-right: 5px;">
                    <img src="../../images/design/pages/delete.png" class="delete" title="删除">
                </div>
                <div style="display:flex;align-items:center;color:#F53F3F;width:50px;padding-left: 5px;">
                    删除
                </div>
            </div>
        </div>
        <div id="ds"
             style="background-color:#F2F3F5;white-space: nowrap;overflow: auto;margin-left:1%;width:96%;height: 90%;border: 1px solid #D5D5D5">
        </div>
    </div>
    <div style="width: 67%;height: 100%;flex-direction: column;display: flex;">
        <div style="height:10%;display: flex;align-items: center;justify-content: flex-start;">
            <button style="width:120px;height:35px;background-color: #FFFFFF;color:#0094FF;border: 1px dashed #0094FF;"
                    class="layui-btn layui-btn-primary layui-btn-sm" onclick="test()">测试链接
            </button>
        </div>
        <div style="height:90%;border: 1px solid #D5D5D5;">
            <form class="layui-form" action="" autocomplete="off" style="margin-top: 20px;margin-right: 10px;">
                <div class="layui-form-item">
                    <label class="layui-form-label">链接名称</label>
                    <div class="layui-input-block">
                        <input type="text" name="connName" lay-verify="required" autocomplete="off"
                               class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">数据库类型</label>
                    <div class="layui-input-block" lay-filter="connType1">
                        <select name="connType" lay-verify="required" lay-filter="connType">
                            <option value="SQLITE">SQLITE</option>
                            <option value="MYSQL">MYSQL</option>
                            <option value="POSTGRESQL">POSTGRESQL</option>
                            <option value="SQL SERVER">SQL SERVER</option>
                            <option value="ORACLE">ORACLE</option>
                            <option value="SYip">SYip</option>
                            <option value="DB2">DB2</option>
                            <option value="INFORMIX">INFORMIX</option>
                            <option value="HIVE">HIVE</option>
                            <option value="SAP">SAP HANA</option>
                            <option value="ODBC">ODBC</option>
                            <option value="IGNITE">IGNITE</option>
                            <option value="JSON">JSON</option>
                            <option value="HTTP">HTTP</option>
                            <option value="HttpDH">HttpDH</option>
                        </select>
                    </div>
                </div>
                <div class="layui-form-item" id="toolTip" style="display: none;">
                    <label class="layui-form-label"></label>
                    <div class="layui-input-block" style="color: red;text-align: left;font-size:12px;">
                        为了保证mysql能正常链接,请在url后面加上参数useUnicode=true&characterEncoding=UTF-8&serverTimezone=Asia/Shanghai&useSSL=false<br>
                        示例:jdbc:mysql://127.0.0.1:3306/test?useUnicode=true&characterEncoding=UTF-8&serverTimezone=Asia/Shanghai&useSSL=false
                    </div>

                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">数据库URL</label>
                    <div class="layui-input-block" lay-filter="connType1">
                        <input type="text" name="connUrl" lay-verify="required" autocomplete="off"
                               class="layui-input">
                    </div>
                </div>

                <div class="layui-form-item" style="display: none;">
                    <label class="layui-form-label">用户名</label>
                    <div class="layui-input-block">
                        <input type="text" name="userName" lay-verify="" class="layui-input" autocomplete="off">
                    </div>
                </div>
                <div class="layui-form-item" style="display: none;">
                    <label class="layui-form-label">密码</label>
                    <div class="layui-input-block">
                        <input type="password" name="password" placeholder="请输入密码" autocomplete="off"
                               class="layui-input"
                               style="display:inline-block;width:94%;">
                        <span class="bind-password2 icon icon-4"></span>
                    </div>
                </div>

            </form>
        </div>

    </div>
</div>
<div>

</div>
</body>

<script type="text/javascript" src="../../js/jquery-1.11.3.min.js"></script>
<script src="../../js/design/canvasCommon.js"></script>
<script type="text/javascript" src="../../js/layui.js"></script>
<script src="../../js/def/global.js"></script>
<script type="text/javascript" src="../../js/design/constants.js"></script>
<script type="text/javascript">
    var ip = window.sessionStorage.getItem("ef_server_base_url");
    let token = window.sessionStorage.getItem("cur_token");

    var isDesign = "1"
    var dbName; //当前选中名
    var allName = [];
    var userType;
    $(function () {
        let production = window.sessionStorage.getItem("cur_production");
        if (production === "true") {
            isDesign = "0";
        }
    })

    function checkUrl(type, url) {
        $.ajax({
            url: url,
            type: type,
            //timeout:5000,
            success: function (res) {
                if (res.code == 1) {
                    layer.msg('链接成功', {icon: 1, time: 2000});
                } else {
                    layer.msg('链接失败', {icon: 2, time: 2000});
                }
            },
            complete: function (XMLHttpRequest, textStatus) {
                var st = XMLHttpRequest.getResponseHeader("sessionstatus");
                if (textStatus == 'timeout') {
                    layer.alert("请求超时,请重试", {icon: 2});
                }
            }
        });
    }

    function test() {
        var url = ip + '/designSys/testDataSource';
        var connType = $("select[name='connType']").val();
        var connUrl = $("input[name='connUrl']").val();
        var userName = $("input[name='userName']").val();
        var password = $("input[name='password']").val();

        var param = '?token=' + token + '&connType=' + connType + '&connUrl=' + encodeURIComponent(connUrl) + '&userName=' + encodeURIComponent(userName) + '&password=' + encodeURIComponent(password);

        if ('WebService(Json)' == connType) {
            if ('' == connUrl) {
                layer.msg('请设置数据库名称', {icon: 2, time: 2000});
                return true;
            }
            checkUrl('post', ip + '/designSys/testJson?token=' + token + '&dbName=' + connUrl);
        } else {

            $.ajax({
                url: url + param,
                type: "post",
                timeout: 5000,
                success: function (res) {
                    console.log(res);
                    if (res.code === 1) {
                        layer.msg(res.text);
                        return true;
                    } else {
                        layer.msg('链接失败');
                    }
                },
                complete: function (XMLHttpRequest, textStatus) {
                    var st = XMLHttpRequest.getResponseHeader("sessionstatus");
                    if (textStatus == 'timeout') {
                        layer.msg("链接失败");
                    }
                }
            });
        }
    }

    var design = 0;

    function setData(d) {
        design = d;
    }

    function save() {
        if ("1" == isDesign) {
            layer.msg("演示环境不能修改");
            return false;
        }

        var db = [];
        var b = false;
        $("#ds a").each(function () {
            if ('' == $('input[name="connName"]').val() || ($('input[name="connName"]').val().length > 0 && $('input[name="connName"]').val().trim().length == 0)) {
                layer.msg("请输入链接名称");
                b = true;
                return false;
            }
            if (!$(this).hasClass('cka')) {
                if ($(this).text() == $('input[name="connName"]').val()) {
                    layer.msg("链接名称已存在");
                    b = true;
                    return false;
                }
            }
            if (Util.isNull($(this).data("db").type)) {
                layer.msg("请设置数据库类型，链接名称：" + $(this).data("db").name);
                b = true;
                return false;
            }
            db.push($(this).data("db"));
        });
        if (!b) {
            db = JSON.stringify(db);
            $.ajax({
                url: ip + "/designSys/saveConn?token=" + token,
                type: "post",
                contentType: "application/json;charset=UTF-8",
                data: db,
                success: function (res) {
                    if (res.state === "success") {
                        layer.msg(res.message);
                        let cur_timer = window.setInterval(function () {
                            var index = parent.layer.getFrameIndex(window.name);
                            parent.layer.close(index);
                            window.clearInterval(cur_timer);
                        }, 1000);
                    }
                },
                complete: function (XMLHttpRequest, textStatus) {
                    var st = XMLHttpRequest.getResponseHeader("sessionstatus");
                    if (textStatus == 'timeout') {
                        layer.alert("请求超时,请重试", {icon: 2});
                    }
                }
            });
        }
    }

    $(document).ready(function () {
        initDB();
        init();
        $('.bind-password2').on('click', function () {
            var psw = $("input[name='password']");
            if ($(this).hasClass('icon-5')) {
                $(this).removeClass('icon-5');
                psw.attr('type', 'password');
            } else {
                $(this).addClass('icon-5');
                psw.attr('type', 'text');
            }
        });
        layui.use('form', function () {
            var form = layui.form;
            form.on('select(connType)', function (data) {
                var type = data.value;

                if ("MYSQL" != type) {
                    $('#toolTip').hide();
                }

                if ('ORACLE' == type) {
                    $("input[name='connUrl']").val('jdbc:oracle:thin:@127.0.0.1:1521/orcl').trigger('change'); //默认URL
                    $("input[name='userName']").parent().parent().show();
                    $("input[name='userName']").val('');
                    $("input[name='password']").parent().parent().show();
                    $("input[name='password']").val('');
                } else if ('SQL SERVER' == type) {
                    $("input[name='connUrl']").val('jdbc:sqlserver://localhost:1433;DataipName=DB').trigger('change');
                    $("input[name='userName']").parent().parent().show();
                    $("input[name='userName']").val('');
                    $("input[name='password']").parent().parent().show();
                    $("input[name='password']").val('');
                } else if ('MYSQL' == type) {
                    $('#toolTip').show();
                    $("input[name='connUrl']").val('jdbc:mysql://localhost:3306/DB').trigger('change');
                    $("input[name='userName']").parent().parent().show();
                    $("input[name='userName']").val('');
                    $("input[name='password']").parent().parent().show();
                    $("input[name='password']").val('');
                } else if ('POSTGRESQL' == type) {
                    $("input[name='connUrl']").val('jdbc:postgresql://localhost:5432/test').trigger('change');
                    $("input[name='userName']").parent().parent().show();
                    $("input[name='userName']").val('');
                    $("input[name='password']").parent().parent().show();
                    $("input[name='password']").val('');
                } else if ('SQLITE' == type) {
                    $("input[name='connUrl']").val('jdbc:sqlite:C://EFReport5//demo.db').trigger('change');
                    $("input[name='userName']").parent().parent().hide();
                    $("input[name='password']").parent().parent().hide();
                } else if ('SYip' == type) {
                    $("input[name='connUrl']").val('jdbc:syip:Tds:192.168.2.103:5000/ext').trigger('change');
                    $("input[name='userName']").parent().parent().show();
                    $("input[name='userName']").val('');
                    $("input[name='password']").parent().parent().show();
                    $("input[name='password']").val('');
                } else if ('DB2' == type) {
                    $("input[name='connUrl']").val('jdbc:db2://192.168.0.52:60000/db_test').trigger('change');
                    $("input[name='userName']").parent().parent().show();
                    $("input[name='userName']").val('');
                    $("input[name='password']").parent().parent().show();
                    $("input[name='password']").val('');
                } else if ('INFORMIX' == type) {
                    $("input[name='connUrl']").val('jdbc:informix-sqli://127.0.0.1:1533/testDB:INFORMIXSERVER=myserver;').trigger('change');
                    $("input[name='userName']").parent().parent().show();
                    $("input[name='userName']").val('');
                    $("input[name='password']").parent().parent().show();
                    $("input[name='password']").val('');
                } else if ('HIVE' == type) {
                    $("input[name='connUrl']").val('jdbc:hive2://192.168.31.243:10000/default').trigger('change');
                    $("input[name='userName']").parent().parent().show();
                    $("input[name='userName']").val('');
                    $("input[name='password']").parent().parent().show();
                    $("input[name='password']").val('');
                } else if ('SAP' == type) {
                    $("input[name='connUrl']").val('jdbc:sap://192.168.0.199:30015?reconnect=true').trigger('change');
                    $("input[name='userName']").parent().parent().show();
                    $("input[name='userName']").val('');
                    $("input[name='password']").parent().parent().show();
                    $("input[name='password']").val('');
                } else if ('ODBC' == type) {
                    $("input[name='connUrl']").val('jdbc:odbc:mytest').trigger('change');
                    $("input[name='userName']").parent().parent().show();
                    $("input[name='userName']").val('');
                    $("input[name='password']").parent().parent().show();
                    $("input[name='password']").val('');
                } else if ('IGNITE' == type) {
                    $("input[name='connUrl']").val('jdbc:ignite:thin://ip:10800').trigger('change');
                    $("input[name='userName']").parent().parent().show();
                    $("input[name='userName']").val('');
                    $("input[name='password']").parent().parent().show();
                    $("input[name='password']").val('');
                } else if ('JSON' == type) {
                    $("input[name='connUrl']").val('C://json//test.json').trigger('change');
                    $("input[name='userName']").parent().parent().hide();
                    $("input[name='password']").parent().parent().hide();
                } else if ('HTTP' == type || 'HttpCommon' == type || 'HttpDH' == type) {
                    $("input[name='connUrl']").val('HTTP://localhost:8080/getData').trigger('change');
                    $("input[name='userName']").parent().parent().hide();
                    $("input[name='password']").parent().parent().hide();
                } else if ('EXCEL' == type) {
                    $("input[name='connUrl']").val('jdbc:odbc:DRIVER={Microsoft Excel Driver (*.xls, *.xlsx, *.xlsm, *.xlsb)};DBQ=D:/test.xlsx;').trigger('change');
                    $("input[name='userName']").parent().parent().hide();
                    $("input[name='password']").parent().parent().hide();
                } else if ('ACCESS' == type) {
                    $("input[name='connUrl']").val('jdbc:odbc:DRIVER={Microsoft Access Driver (*.mdb, *.accdb)};DBQ=D:/test/filename.accdb;').trigger('change');
                    $("input[name='userName']").parent().parent().hide();
                    $("input[name='password']").parent().parent().hide();
                } else if ('REDIS' == type) {
                    $("input[name='connUrl']").val('192.168.0.199:6379?index=0').trigger('change');
                    $("input[name='userName']").parent().parent().show();
                    $("input[name='userName']").val('');
                    $("input[name='password']").parent().parent().show();
                    $("input[name='password']").val('');
                } else {
                    $("input[name='connUrl']").val('').trigger('change');
                    $("input[name='userName']").parent().parent().show();
                    $("input[name='userName']").val('');
                    $("input[name='password']").parent().parent().show();
                    $("input[name='password']").val('');
                }

                var db = $("#ds a.cka").data("db");
                if (db) {
                    db.type = type;
                }
            });
            form.on('submit(add)', function (data) {

            });
        });
        $('form input').change(function () {
            let ele = $(this);
            var db = $("#ds a.cka").data("db");
            if (db) {
                var val = $(this).val();
                var name = $(this).attr("name");
                if ("connName" == name) {
                    var flag = true;
                    var dsa = $('#ds a'); //判断当前已经存在的数据链接名
                    $.each(dsa, function (index, element) {
                        if (element.text != dbName) { //非当前选择项
                            if (element.text == val) {
                                flag = false;
                                layer.alert('数据链接名重复,请重新命名!');
                            }
                        }
                    });
                    $.each(allName, function (index, element) {
                        if (element == val) {
                            flag = false;
                            layer.alert('该数据链接名称已被其他用户使用,请重新命名!');
                            ele.val($('.cka').text()); // 还原名称
                        }
                    });
                    if (flag) {
                        $("#ds a.cka").text(val);
                        db.name = val;
                    }

                } else if ("connType" == name) {
                    db.type = val;
                } else if ("connUrl" == name) {
                    db.url = val;
                } else if ("userName" == name) {
                    db.username = val;
                } else if ("password" == name) {
                    db.password = val;
                }
            }
        });
        $("#add").click(function () {
            var b = check();
            if (b) {
                return false;
            }
            let newConn = "newConn";
            let names = new Array();
            $("#ds a").each(function () {
                $(this).removeClass("cka");
                $(this).addClass("ncka");
                let name = $(this).data("db").name;
                if (name.indexOf("newConn") == 0) {
                    var index = name.split("newConn")[1];
                    if (Util.isInteger(index)) {
                        names.push(parseInt(index));
                    }
                }
            });

            $.each(allName, function (i, e) {
                let name = e;
                if (name.indexOf("newConn") == 0) {
                    var index = name.split("newConn")[1];
                    if (Util.isInteger(index)) {
                        names.push(parseInt(index));
                    }
                }
            })

            if (names.length > 0) {
                names.sort(function sequence(a, b) {
                    return a - b;
                });
                var last = names.pop();
                newConn += last + 1;
            } else {
                newConn += 1;
            }
            $("#ds").append("<a href='javascript:;'>" + newConn + "</a>");
            var tmp = {
                name: newConn, type: '', url: '', username: '', password: ''
            };
            $("#ds").children("a:last-child").data("db", tmp);
            $("#ds a:last-child").click(function () {
                var b = check();
                if (!b) {
                    $("#ds a").each(function () {
                        $(this).addClass("ncka");
                        $(this).removeClass("cka");
                    });
                    $(this).removeClass("ncka");
                    $(this).addClass("cka");
                    setDb($(this));
                }
            });
            var t = $("#ds a:last-child");
            t.removeClass("ncka");
            t.addClass("cka");
            setDb(t);
        });
        $("#del").click(function () {
            layer.confirm('确定删除?', {icon: 3, title: '提示'}, function (index) {
                layer.close(index);
                $("#ds a").each(function () {
                    var th = $(this);
                    if (th.hasClass("cka")) {
                        th.remove();
                    }
                });
                $("#ds a:last-child").trigger("click");
                if ($("#ds a:last-child")[0] == undefined) {
                    $("input[name='connName']").val('');
                    $("input[name='dbName']").val('');
                    $("select[name='connType']").val('SQLITE');
                    $("input[name='hostName']").val('');
                    $("input[name='port']").val('');
                    $("input[name='userName']").val('');
                    $("input[name='password']").val('');
                    renderForm();
                    $("input[name='userName']").parent().parent().hide();
                    $("input[name='password']").parent().parent().hide();
                    $("input[name='hostName']").parent().parent().hide();
                    $("input[name='port']").parent().parent().hide();
                }
            });
        });
    });

    function check() {
        var b = false;
        if ($("#ds a.cka")[0]) {
            var db = $("#ds a.cka").data("db");
            if ('' == db.name || (db.name.length > 0 && db.name.trim().length == 0)) {
                layer.alert("请输入链接名称", {icon: 2});
                b = true;
            }
            if (Util.isNull(db.type)) {
                layer.alert("请设置数据库类型", {icon: 2});
                b = true;
            }

            //判断同名链接
            $.each(allName, function (i, e) {
                if (e == db.connName) {
                    layer.alert("链接名称已被使用", {icon: 2});
                    b = true;
                    return false;
                }
            })


            $("#ds a").each(function () {
                if (!$(this).hasClass('cka')) {
                    if ($(this).text() == db.connName) {
                        layer.alert("链接名称已存在", {icon: 2});
                        b = true;
                        return false;
                    }
                }
            });
        }
        return b;
    }

    function saveConn() {
        var db = [];
        $("#ds a").each(function () {
            db.push($(this).data("db"));
        });
        db = JSON.stringify(db);
        $.ajax({
            url: ip + "/designSys/saveConn?token=" + token,
            type: "post",
            contentType: "application/json;charset=UTF-8",
            data: db,
            success: function (res) {
                if (res.state === "success") {
                    layer.msg(res.message, {icon: 1, time: 2000});
                    return true;
                }
            },
            complete: function (XMLHttpRequest, textStatus) {
                var st = XMLHttpRequest.getResponseHeader("sessionstatus");
                if (textStatus == 'timeout') {
                    layer.alert("请求超时,请重试", {icon: 2});
                }
            }
        });
    }

    function init() {
        $("#ds").empty();
        $('form')[0].reset();

        let url = ip + "/designSys/getConnInfo?token=" + token;
        $.ajax({
            url: url,
            type: "get",
            timeout: 5000,
            contentType: "application/json;charset=UTF-8",
            success: function (data) {
                if (data.state === "success") {
                    //if (!Util.isNull(data.data)) {
                    var tmp = data.data;
                    allName = data.names;
                    userType = data.userType;
                    var li = "<a href='javascript:;'>${connName}</a>";
                    if (tmp.length == 0) { // 当前用户没有数据链接

                    }
                    $.each(tmp, function (i) {
                        var li; //whj
                        if (userType == 2) {
                            if (tmp[i].designName == undefined) {
                                li = "<a href='javascript:;' class='ncka'>" + tmp[i].name + "</a>"; //whj
                            } else {
                                //li = "<a href='javascript:;'>" + tmp[i].name + "</a><span style='display: inline-block;'>("+ tmp[i].designName +")</span>"; //whj
                                li = "<a href='javascript:;' class='ncka'>" + tmp[i].name + "</a>"; //whj
                            }
                        } else {
                            li = "<a href='javascript:;' class='ncka'>" + tmp[i].name + "</a>"; //whj
                        }
                        $("#ds").append(li);
                        $("#ds").children("a:last-child").data("db", tmp[i]);
                    });
                    $("#ds a").click(function () {
                        var b = check();
                        if (!b) {
                            $("#ds a").each(function () {
                                $(this).addClass("ncka");
                                $(this).removeClass("cka");
                            });
                            $(this).removeClass("ncka");
                            $(this).addClass("cka");
                            setDb($(this));
                        }
                        dbName = $(this).text(); //当前链接名
                    });
                    var t = $("#ds a:first-child");
                    t.addClass("cka");
                    t.removeClass("ncka");
                    setDb(t);
                    //}

                } else if (data.state === "notExist") { //数据链接文件不存在

                } else {
                    layer.alert(data.data);
                }
            },
            complete: function (XMLHttpRequest, textStatus) {
                var st = XMLHttpRequest.getResponseHeader("sessionstatus");
                if (textStatus == 'timeout') {
                    layer.alert("请求超时,请重试", {icon: 2});
                }
            }, error: function (XMLHttpRequest, textStatus, errorThrown) {
            }
        });
    }

    function setDb(db) {
        var db = db.data("db");
        if (db != undefined) {

            if (db.type == 'MYSQL') {
                $('#toolTip').show();
            } else {
                $('#toolTip').hide();
            }

            $("input[name='connName']").val(db.name); //填充链接名
            $("select[name='connType']").val(db.type).prop("selected", "true");//数据库类型
            $("input[name='connUrl']").val(db.url); //数据库url
            $("input[name='userName']").val(db.username); //数据库用户名
            $("input[name='password']").val(db.password); //数据库密码
            if ('SQLITE' == db.type) {
                $("input[name='userName']").parent().parent().hide();
                $("input[name='password']").parent().parent().hide();
            } else if ('MemoryDB' == db.type) {
                $("input[name='userName']").parent().parent().hide();
                $("input[name='password']").parent().parent().hide();
            } else if ('HTTP' == db.type || 'HttpCommon' == db.type || 'HttpDH' == db.type) {
                $("input[name='userName']").parent().parent().hide();
                $("input[name='password']").parent().parent().hide();
            } else if ('JSON' == db.type) {
                $("input[name='userName']").parent().parent().hide();
                $("input[name='password']").parent().parent().hide();
            } else if ('EXCEL' == db.type) {
                $("input[name='userName']").parent().parent().hide();
                $("input[name='password']").parent().parent().hide();
            } else if ('ACCESS' == db.type) {
                $("input[name='userName']").parent().parent().hide();
                $("input[name='password']").parent().parent().hide();
            } else if ('WebService(Json)' == db.type) {
                $("input[name='dbName']").parent().parent().show();
                $("input[name='hostName']").parent().parent().hide();
                $("input[name='port']").parent().parent().hide();
                $("input[name='userName']").parent().parent().hide();
                $("input[name='password']").parent().parent().hide();
            } else {
                $("input[name='dbName']").parent().parent().show();
                $("input[name='hostName']").parent().parent().show();
                $("input[name='port']").parent().parent().show();
                $("input[name='userName']").parent().parent().show();
                $("input[name='password']").parent().parent().show();
            }
        } else {
            $("input[name='connName']").val('');
            $("input[name='dbName']").val('');
            $("select[name='connType']").val('SQLITE').prop("selected", "true");//数据库类型
            $("input[name='hostName']").val('');
            $("input[name='port']").val('');
            $("input[name='userName']").val('');
            $("input[name='password']").val('');
            $("input[name='connUrl']").val('jdbc:sqlite:C://EFReport5//demo.db'); //数据库url
        }
        renderForm();
    }

    function initDB() {
        $.ajax({
            url: ip + "/designSys/getDB?token=" + token,
            type: "post",
            dataType: 'json',
            success: function (res) {
                if (res.state == 'success') {
                    var dbs = res.dbs;
                    $.each(dbs, function (index, ele) {
                        $('select[name="connType"]').append('<option value="' + ele + '">' + ele + '</option>');
                    })

                }
            },
            error: function () {
            }


        })


    }

    function renderForm() {
        layui.use('form', function () {
            var form = layui.form; //只有执行了这一步，部分表单元素才会自动修饰成功
            form.render();
        });
    }
</script>
</html>
