<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8"/>
    <link rel="stylesheet" href="../../js/css/layui.css">
    <link rel="stylesheet" href="../../css/xadmin.css">
    <!--<link rel="stylesheet" href="../../css/scroll.css">-->

    <style type="text/css">
        .layui-btn {
            background-color: #1e9fff;
        }

    </style>
</head>

<body>
<div class="x-body">
    <div class="layui-row" style="display: flex;align-items: center;justify-content: center;">
        <form class="layui-form layui-col-md12 x-so" style="height: 22px;" onsubmit="return false;">
            <button type="button" id="batchUpload" class="layui-btn" title="批量上传"><i class="layui-icon">&#xe681;</i>
            </button>
            <input type="text" name="name" autocomplete="off" class="layui-input"
                   style="width: 332px;height:32px;line-height:32px;">
            <button type="button" id="search" class="layui-btn" data-type="reload" title="搜索"><i class="layui-icon">&#xe615;</i>
            </button>
            <button type="button" id="filter" class="layui-btn" title="同步模板"><i class="layui-icon">&#xe857;</i></button>
            <button type="button" id="batchDelete" class="layui-btn" title="批量删除"><i class="layui-icon">&#xe640;</i>
            </button>
            <button type="button" id="batchDownload" class="layui-btn" title="批量导出"><i class="layui-icon">&#xe601;</i>
            </button>
            <button type="button" id="batchChange" class="layui-btn" title="批量修改目录"><i class="layui-icon">&#xe63c;</i>
            </button>
            <button type="button" id="batchOrder" class="layui-btn" title="模板排序"><i class="layui-icon">&#xe63c;</i>
            </button>
        </form>
    </div>
    <table class="layui-hide" id="grid" lay-filter="useruv"></table>
    <script type="text/html" id="opMenuBar">
        <a class="layui-btn layui-btn-sm" lay-event="del" title="删除当前模板"><i class="layui-icon">&#xe640;</i></a>
        <a class="layui-btn layui-btn-sm" lay-event="down" title="下载当前模板"><i class="layui-icon">&#xe601;</i></a>
    </script>
</div>
</body>
<script type="text/javascript" src="../../js/jquery-1.11.3.min.js"></script>
<script type="text/javascript" src="../../js/layui.js"></script>
<script type="text/javascript">
    var table;
    var filterData = {}; //过滤条件数据
    var ip = window.sessionStorage.getItem("ef_server_base_url");
    var token = window.sessionStorage.getItem("cur_token");
    var ids = [];

    function setFilterData(data) {
        filterData = data;
    }

    function getFilterData() {
        return filterData;
    }

    function refresh() {
        layer.closeAll();
        window.location.reload();
    }


    //表格重载
    function reloadTable(data) {
        layer.closeAll();
        table.reload('grid', {
            where: {
                status: data.status,
                operator: data.operator,
                start: data.start,
                end: data.end
            }
        });
    }

    function reloadTableW() {
        table.reload('grid', {});
    }


    layui.use('table', function () {
        table = layui.table;
        table.render({
            elem: '#grid',
            height: 500,
            url: ip + '/template/listTemplates' + "?t=" + new Date().getTime() + '&token=' + token,
         /*   page: {
                layout: ['prev', 'page', 'next', 'skip'],
                groups: 5,
                first: '<i class="layui-icon">&#xe65a;</i>',
                last: '<i class="layui-icon">&#xe65b;</i>'
            },*/
            page: true,
            cols: [[ //表头
                {
                    field: 'id',
                    title: 'id',
                    width: 160
                },
                {
                    field: 'name',
                    title: '模板名',
                    width: 330
                },
                {
                    field: 'createTime',
                    title: '创建时间',
                    width: 210,
                    templet: function (res) {
                        var datetime = new Date(res.createTime);
                        var year = datetime.getFullYear();
                        var month = datetime.getMonth() + 1 < 10 ? "0" + (datetime.getMonth() + 1) : datetime.getMonth() + 1;
                        var date = datetime.getDate() < 10 ? "0" + datetime.getDate() : datetime.getDate();
                        var hour = datetime.getHours() < 10 ? "0" + datetime.getHours() : datetime.getHours();
                        var minute = datetime.getMinutes() < 10 ? "0" + datetime.getMinutes() : datetime.getMinutes();
                        var second = datetime.getSeconds() < 10 ? "0" + datetime.getSeconds() : datetime.getSeconds();
                        return year + "-" + month + "-" + date + " " + hour + ":" + minute + ":" + second;
                    }
                },
                {
                    field: 'RIGHT',
                    title: '操作',
                    width: 220,
                    toolbar: "#opMenuBar"
                }
            ]],
            done: function (res) {
                //$("[data-field='ID']").css('display', 'none');
            }
        });

        table.on('tool(useruv)', function (obj) {
            var data = obj.data;
            var layEvent = obj.event;

            let production = window.sessionStorage.getItem("cur_production"); //是否允许保存
            if (production != 'true') {
                layer.msg('演示环境不允许操作');
                return;
            }

            if (layEvent === 'del') {
                layer.confirm('确定删除?', function (index) {
                    $.ajax({
                        url: ip + "/template/del?id=" + data.id + "&name=" + encodeURI(data.path) + "&t=" + new Date().getTime() + "&token=" + token,
                        type: "POST",
                        success: function (resp) {
                            if (resp.state == 'success') {
                                layer.msg("操作成功", {time: 1000}, function () {
                                    table.reload('grid', {});
                                    window.parent.initTree();
                                });
                            } else {
                                layer.msg(resp.text);
                            }
                        }
                    });
                });
            } else if (layEvent === 'down') {
                window.open(ip + '/template/down?id=' + data.id + "&token=" + token);
            }
        });

        $('#search').on('click', function () {
            filterData.name = $("input[name=name]").val();
            table.reload('grid', {
                where: {
                    name: $("input[name=name]").val()
                },
                page: {
                    curr: 1 //重新从第 1 页开始
                }
            });
        });

        $(document).on('keyup', function (event) {
            if (event.keyCode == 13) {
                table.reload('grid', {
                    where: {
                        name: $("input[name=name]").val()
                    }
                });
            }
        });

        $('#filter').bind('click', function () {


            let production = window.sessionStorage.getItem("cur_production"); //是否允许保存
            if (production != 'true') {
                layer.msg('演示环境不允许同步');
                return;
            }

            $.ajax({
                url: ip + '/template/synTemplate?token=' + token,
                type: 'post',
                success: function (res) {
                    if (res.state == 'success') {
                        layer.msg("同步成功", {time: 1000}, function () {
                            table.reload('grid', {
                                page: {
                                    curr: 1 //重新从第 1 页开始
                                }
                            });
                            //更新树形结构
                            window.parent.initTree();
                        });
                    }
                }
            })

        })

        //批量删除
        $('#batchDelete').bind('click', function () {

            let index = layer.open({
                type: 2,
                area: ['350px', '480px'],
                closeBtn: 0,
                title: ['选择要删除的模板', 'height:30px;line-height:30px'],
                content: ['template.html', 'no'],
                btn: ['确定', '关闭'],
                btnAlign: 'c',
                end: function () {
                },
                success: function (layero, index) {
                    let iframeWin = window[layero.find('iframe')[0]['name']];

                    iframeWin.init();
                },
                yes: function (index, layero) {

                    let production = window.sessionStorage.getItem("cur_production"); //是否允许保存
                    if (production != 'true') {
                        layer.msg('演示环境不允许删除');
                        return;
                    }

                    let iframeWin = window[layero.find('iframe')[0]['name']];
                    let ids = iframeWin.getDeleteIds();
                    if (ids.length == 0) {
                        layer.msg('请选择要删除的模板');
                    } else {
                        $.ajax({
                            url: ip + "/template/batchDelete?id=" + ids + "&token=" + token,
                            type: "POST",
                            success: function (resp) {
                                if (resp.state == 'success') {
                                    layer.closeAll();
                                    layer.msg("批量删除成功", {time: 1000}, function () {
                                        table.reload('grid', {});
                                        //更新树形结构
                                        window.parent.initTree();
                                    });
                                } else {
                                    layer.msg(resp.text);
                                }
                            }
                        });
                    }

                }
            });

        })
        //批量下载
        $('#batchDownload').bind('click', function () {

            let index = layer.open({
                type: 2,
                area: ['350px', '480px'],
                closeBtn: 0,
                title: ['选择要导出的模板', 'height:30px;line-height:30px'],
                content: ['template.html', 'no'],
                btn: ['全选', '确定', '关闭'],
                btnAlign: 'c',
                end: function () {
                },
                success: function (layero, index) {
                    let iframeWin = window[layero.find('iframe')[0]['name']];
                    iframeWin.init();
                },
                yes: function (index, layero) {
                    let iframeWin = window[layero.find('iframe')[0]['name']];
                    let text = $('.layui-layer-btn0').text();
                    if (text == '全选') {
                        iframeWin.chooseAll(1);
                        $('.layui-layer-btn0').text('全不选');
                    } else {
                        iframeWin.chooseAll(0);
                        $('.layui-layer-btn0').text('全选');
                    }
                    return false;
                },
                btn2: function (index, layero) {
                    let iframeWin = window[layero.find('iframe')[0]['name']];
                    let ids = iframeWin.getDeleteIds();
                    if (ids.length == 0) {
                        layer.msg('请选择要导出的模板');
                    } else {
                        let url = ip + "/template/batchDownload?id=" + ids + "&token=" + token;
                        layer.closeAll();
                        window.open(url);
                    }

                }
            });
        })

    });


    //批量修改目录
    $('#batchChange').bind('click', function () {
        let index = layer.open({
            type: 2,
            area: ['700px', '480px'],
            closeBtn: 0,
            title: ['修改模板目录', 'height:30px;line-height:30px'],
            content: ['changeMenu.html', 'no'],
            btn: ['全选', '确定', '关闭'],
            btnAlign: 'c',
            end: function () {
            },
            success: function (layero, index) {
                let iframeWin = window[layero.find('iframe')[0]['name']];
                iframeWin.init();
            },
            yes: function (index, layero) {

                let iframeWin = window[layero.find('iframe')[0]['name']];
                let text = $('.layui-layer-btn0').text();
                if (text == '全选') {
                    iframeWin.chooseAll(1);
                    $('.layui-layer-btn0').text('全不选');
                } else {
                    iframeWin.chooseAll(0);
                    $('.layui-layer-btn0').text('全选');
                }
                return false;
            },
            btn2: function (index, layero) {

                let production = window.sessionStorage.getItem("cur_production"); //是否允许保存
                if (production != 'true') {
                    layer.msg('演示环境不允许修改');
                    return;
                }

                let iframeWin = window[layero.find('iframe')[0]['name']];
                let res = iframeWin.getDeleteIds();
                let ids = res.checkedId;
                let menuId = res.menuId;
                let idParam = '';
                $.each(ids, function (i, e) {
                    if (i == ids.length - 1) {
                        idParam += e;
                    } else {
                        idParam += (e + ',');
                    }
                })
                $.ajax({
                    url: ip + '/designSys/changeMenu?menuId=' + menuId + '&token=' + token + '&ids=' + idParam,
                    type: 'post',
                    success: function (data) {
                        if (data.state == 'success') { //保存成功
                            layer.msg("修改成功", {time: 1000}, function () {
                                layer.closeAll();
                                table.reload('grid', {});
                                //更新树形结构
                                window.parent.initTree();
                            });
                        } else {
                            layer.msg("保存失败");
                        }
                    },
                    error: function () {

                    }
                });


            }
        });
    })


    //批量排序
    $('#batchOrder').bind('click', function () {
        let index = layer.open({
            type: 2,
            area: ['400px', '480px'],
            closeBtn: 0,
            title: ['模板排序', 'height:30px;line-height:30px'],
            content: ['templateOrder.html', 'no'],
            btn: ['确定', '关闭'],
            btnAlign: 'c',
            end: function () {
            },
            success: function (layero, index) {
                let iframeWin = window[layero.find('iframe')[0]['name']];
                iframeWin.init();
            },
            yes: function (index, layero) {

                let iframeWin = window[layero.find('iframe')[0]['name']];
                let treeNodes = iframeWin.getTreeNodes();
                $.ajax({
                    url:ip + "/template/saveNewOrder?token=" + token,
                    type:'post',
                    contentType: "application/json;charset=UTF-8",
                    data: JSON.stringify(treeNodes),
                    success:function(res){
                        if(res.state == 'success'){
                            layer.msg('修改成功',{
                                time:2000
                            },function(){
                                layer.closeAll();
                                window.parent.initTree();
                            });

                        }else{
                            layer.msg('修改顺序失败');
                        }
                    },
                    error:function(){}
                })
            }
        });
    })

    //批量修改目录
    $('#share').bind('click', function () {
        let index = layer.open({
            type: 2,
            area: ['550px', '480px'],
            closeBtn: 0,
            title: ['分享模板', 'height:30px;line-height:30px'],
            content: ['shareTemplate.html', 'no'],
            btn: ['确定', '关闭'],
            btnAlign: 'c',
            end: function () {
            },
            success: function (layero, index) {
                let iframeWin = window[layero.find('iframe')[0]['name']];
                iframeWin.init();
            },
            yes: function (index, layero) {
                let iframeWin = window[layero.find('iframe')[0]['name']];
                let text = $('.layui-layer-btn0').text();
                if (text == '全选') {
                    iframeWin.chooseAll(1);
                    $('.layui-layer-btn0').text('全不选');
                } else {
                    iframeWin.chooseAll(0);
                    $('.layui-layer-btn0').text('全选');
                }
                return false;
            },
            btn2: function (index, layero) {
                let iframeWin = window[layero.find('iframe')[0]['name']];
            }
        });
    })

    let production = window.sessionStorage.getItem("cur_production"); //是否允许保存
    if (production != 'true') {

    } else {
        layui.use('upload', function () {
            $("#mask").hide();
            let upload = layui.upload;
            upload.render({
                elem: '#batchUpload'
                , url: ip + '/designSys/uploadCels?token=' + token
                , accept: 'file'
                , exts: 'cel'
                , multiple: true
                , done: function (res) {
                    if (res.state == 'success') {
                        ids.push(res.ids); //上传的模板id
                        layer.msg('上传成功，请设置模板目录');
                        table.reload('grid', {});
                    } else {
                        layer.msg('上传失败');
                    }
                }
                , allDone: function () {
                    //选择模板目录
                    let index = layer.open({
                        type: 2,
                        area: ['350px', '480px'],
                        closeBtn: 0,
                        title: ['模板目录', 'height:30px;line-height:30px'],
                        content: ['menu.html', 'no'],
                        btn: ['确定', '关闭'],
                        btnAlign: 'c',
                        end: function () {
                        },
                        success: function (layero, index) {
                            let iframeWin = window[layero.find('iframe')[0]['name']];
                            iframeWin.init();
                        },
                        yes: function (index, layero) {
                            let iframeWin = window[layero.find('iframe')[0]['name']];
                            let menuId = iframeWin.getMenuId(); //获取模板目录ID
                            let idParam = '';
                            $.each(ids, function (i, e) {
                                if (i == ids.length - 1) {
                                    idParam += e;
                                } else {
                                    idParam += (e + ',');
                                }
                            })
                            $.ajax({
                                url: ip + '/designSys/changeMenu?menuId=' + menuId + '&token=' + token + '&ids=' + idParam,
                                type: 'post',
                                success: function (data) {
                                    if (data.state == 'success') { //保存成功
                                        layer.msg('保存成功', {time: 1000}, function () {
                                            layer.closeAll();
                                            table.reload('grid', {});
                                            window.parent.parent.initTree();
                                        });

                                    } else {
                                        layer.alert("保存失败");
                                    }
                                },
                                error: function () {

                                }
                            });
                        }
                    });
                }
                , before: function (obj) {
                    let production = window.sessionStorage.getItem("cur_production"); //是否允许保存
                    if (production != 'true') {
                        layer.msg('演示环境不允许上传');
                        return;
                    }
                }
            });
        });
    }


</script>
</html>