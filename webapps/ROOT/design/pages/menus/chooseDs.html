<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="Cache-Control" content="no-cache, no-store">
    <meta http-equiv="expires" content="0">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link href="../../js/css/layui.css" rel="stylesheet">
    <link rel="stylesheet" href="../../js/zTree/css/zTreeStyle.css" type="text/css">
    <style>
        html {
            width: 100%;
            height: 100%;
        }

        body {
            width: 100%;
            height: 100%;
        }

        input {
            background-color: #F2F3F5;
        }

        input:hover {
            border: 1px solid #44B4FF;
            background-color: #FFFFFF;
        }

        select {
            background-color: #F2F3F5;
        }

        select:hover {
            border: 1px solid #44B4FF;
            background-color: #FFFFFF;
        }

        .layui-input {
            background-color: #F2F3F5;
        }

        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-thumb {
            border-radius: 10px;
            -webkit-box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2);
            background: #d5d5d5;
        }

    </style>
</head>
<body>
<div style="display:flex;width:100%;height:100%;">
    <div style="width: 30%;height: 100%;overflow: hidden;flex-direction: column;display: flex;">
        <div style="height:5%;display: flex;align-items: center;justify-content: center;">

        </div>
        <ul id="ds" class="ztree"
             style="padding:0px;background-color:#F2F3F5;white-space: nowrap;overflow: auto;margin-left:1%;width:96%;height: 90%;border: 1px solid #D5D5D5">
        </ul>
    </div>
    <div style="width: 67%;height: 100%;flex-direction: column;display: flex;">
        <div style="height:5%;display: flex;align-items: center;justify-content: flex-start;">

        </div>
        <div style="height:90%;border: 1px solid #D5D5D5;">
            <form class="layui-form" action="" autocomplete="off" style="margin-top: 20px;margin-right: 10px;">
                <div class="layui-form-item">
                    <label class="layui-form-label">数据集名称</label>
                    <div class="layui-input-block">
                        <input type="text" name="dsName" lay-verify="required" autocomplete="off"
                               class="layui-input" disabled="disabled">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">数据链接</label>
                    <div class="layui-input-block">
                        <input type="text" name="connName" lay-verify="required" autocomplete="off"
                               class="layui-input" disabled="disabled">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">SQL</label>
                    <div class="layui-input-block">
                        <textarea name="dsSql" placeholder="请输入内容" class="layui-textarea"
                                  style="height:250px;" disabled="disabled"></textarea>
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">备注</label>
                    <div class="layui-input-block">
                        <textarea name="dsMemo" placeholder="请输入内容" class="layui-textarea"
                                  style="height:50px;" disabled="disabled"></textarea>
                    </div>
                </div>
            </form>
        </div>

    </div>
</div>
<div>

</div>
</body>

<script type="text/javascript" src="../../js/jquery-1.11.3.min.js"></script>
<script type="text/javascript" src="../../js/layui.js"></script>
<script type="text/javascript" src="../../js/zTree/js/jquery.ztree.all.min.js"></script>
<script type="text/javascript" src="../../js/zTree/js/jquery.ztree.exhide.min.js"></script>
<script type="text/javascript">
    let ip = window.sessionStorage.getItem("ef_server_base_url");
    let token = window.sessionStorage.getItem("cur_token");
    let id;
    let dsData;
    let dsDataMap = {};
    let treeObj;

    $(document).ready(function () {
        init();
    });

    function initTree(data) {
        let setting = {
            view:{
                showLine:false,
                showIcon:false
            },
            data: {
                simpleData: {
                    enable: true,
                    idKey: "id",
                    pIdKey: "pId",
                    rootPid:0
                }
                , key: {
                    isParent: 'isParent'
                }
            },
            check: {
                checkType:'checkbox',
                enable: true
            },
            callback: {
                onClick: function (event, id, node) {
                    let dsId = node.id;
                    let dsData = dsDataMap[dsId];
                    setData(dsData);
                },
                onCheck: function(event , id ,node){

                }
            }
        };
        treeObj = $.fn.zTree.init($("#ds"), setting, data);
        treeObj.expandAll(true);
    }

    function init(dsArray) {
        let url = ip + "/ds/list?token=" + token;
        $.ajax({
            url: url,
            type: "get",
            timeout: 5000,
            contentType: "application/json;charset=UTF-8",
            success: function (data) {
                let treeData = [];
                let rootObj = {'id':0,'name':'通用数据集','open':true,'isParent':true,'isRoot':true,'chkDisabled':false,'iconSkin':'template'}
                treeData.push(rootObj);
                if (data.state === "success") {
                    dsData = data.data;
                    $.each(dsData, function (i, e) {
                        dsDataMap[e.id] = e;
                        let dsObj;
                        if($.inArray(e.dsName , dsArray) != -1){ //已经选择
                            dsObj = {'id':e.id,'name':e.dsName,'pId':0,'isParent':false,'iconSkin':'template','checked':true}
                        }else{
                            dsObj = {'id':e.id,'name':e.dsName,'pId':0,'isParent':false,'iconSkin':'template'}
                        }
                        treeData.push(dsObj);
                    });
                    initTree(treeData);
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
            }
        });
    }

    function setData(data) {
        let db = data
        id = db.id;
        $("input[name='dsName']").val(db.dsName);//数据集
        $("input[name='connName']").val(db.connName); //数据连接
        $("textArea[name='dsSql']").val(db.dsSql); //sql
        $("textArea[name='dsMemo']").val(db.dsMemo); //sql memo
        renderForm();
    }

    function getDs(){
        let dsArray = [];
        let checkNodes = treeObj.getCheckedNodes(true);
        $.each(checkNodes , function(i,e){
            let id = e.id;
            if(id != 0){
                let ds = dsDataMap[id];
                let dsObj = {
                    SqlStr: ds.dsSql,
                    DSName: ds.dsName,
                    ConnName: ds.connName,
                    sqlMemo: ds.dsMemo,
                };
                dsArray.push(dsObj);
            }
        })
        return dsArray;
    }


    function renderForm() {
        layui.use('form', function () {
            var form = layui.form; //只有执行了这一步，部分表单元素才会自动修饰成功
            form.render();
        });
    }
</script>
</html>
