<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8"/>
    <link rel="stylesheet" href="../../js/css/layui.css">
    <link rel="stylesheet" href="../../css/xadmin.css">

    <style type="text/css">
        .layui-btn {
            background-color: #1e9fff;
        }

        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-thumb {
            border-radius: 10px;
            -webkit-box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2);
            background: #d5d5d5;
        }

    </style>
</head>

<body>
<div class="x-body">
    <div class="layui-row" style="display: flex;align-items: center;">
        <input type="text" name="templateName" autocomplete="off" class="layui-input" placeholder="模板"
               style="width: 150px;height:32px;line-height:32px;margin-right: 10px;">

        <button type="button" id="search" class="layui-btn" data-type="reload" title="搜索"
                style="height:30px;line-height:30px;"><i class="layui-icon">&#xe615;</i>
        </button>
        <button type="button" id="clear" class="layui-btn" title="清空日志"
                style="height:30px;line-height:30px;"><i class="layui-icon">&#xe640;</i>
        </button>
    </div>
    <table class="layui-hide" id="grid" lay-filter="useruv"></table>
</div>
</body>
<script type="text/javascript" src="../../js/jquery-1.11.3.min.js"></script>
<script type="text/javascript" src="../../js/layui.js"></script>
<script type="text/javascript">
    var table;
    var filterData = {}; //过滤条件数据
    var ip = window.sessionStorage.getItem("ef_server_base_url");
    var token = window.sessionStorage.getItem("cur_token");
    var ids = [];

    function setFilterData(data) {
        filterData = data;
    }

    function getFilterData() {
        return filterData;
    }

    function refresh() {
        layer.closeAll();
        window.location.reload();
    }


    //表格重载
    function reloadTable(data) {
        layer.closeAll();
        table.reload('grid', {
            where: {
                status: data.status,
                operator: data.operator,
                start: data.start,
                end: data.end
            }
        });
    }

    function reloadTableW() {
        table.reload('grid', {});
    }


    layui.use('table', function () {
        table = layui.table;
        table.render({
            elem: '#grid',
            height: 500,
            url: ip + '/thirdSys/listSqlLogs' + "?t=" + new Date().getTime() + '&token=' + token,
            page: true,
            cols: [[ //表头
                {
                    field: 'templateName',
                    title: '模板名',
                    width: 150
                },
                {
                    field: 'pathId',
                    title: '任务ID',
                    width: 100
                },
                {
                    field: 'params',
                    title: '参数',
                    width: 200
                },
                {
                    field: 'createTime',
                    title: '创建时间',
                    width: 160
                },
                {
                    field: 'dataSql',
                    title: 'SQL',
                    width: 300
                }
            ]],
            done: function (res) {

            }
        });

        $('#search').on('click', function () {
            table.reload('grid', {
                where: {
                    templateName: $("input[name='templateName']").val()
                },
                page: {
                    curr: 1 //重新从第 1 页开始
                }
            });
        });
        $('#clear').on('click' , function(){
            $.ajax({
                url:ip + '/thirdSys/clearSqlLogs?token=' + token,
                type:'GET',
                success:function(res){
                    if(res.state == 'success'){
                        table.reload('grid', {
                            page: {
                                curr: 1 //重新从第 1 页开始
                            }
                        });
                    }else{
                        layer.msg(res.message);
                    }
                }
            })
        })

        $(document).on('keyup', function (event) {
            if (event.keyCode == 13) {
                table.reload('grid', {
                    where: {
                        templateName: $("input[name='templateName']").val()
                    }
                });
            }
        });
    });
</script>
</html>