<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="Cache-Control" content="no-cache, no-store">
    <meta http-equiv="expires" content="0">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../../js/css/layui.css">
    <link href="../../css/scroll.css" rel="stylesheet">
    <link href="../../js/css/codemirror.css" rel="stylesheet">
    <link href="../../js/codemirror/foldgutter.css" rel="stylesheet">
    <link href="../../js/codemirror/show-hint.css" rel="stylesheet">
    <link href="../../js/codemirror/eclipse.css" rel="stylesheet">
    <link href="../../js/codemirror/dialog.css" rel="stylesheet">

    <style>

        html {
            width: 100%;
            height: 100%;
            padding: 0px;
            margin: 0px;
        }

        body {
            width: 100%;
            height: 100%;
            padding: 0px;
            margin: 0px;
        }

        .label {
            font-size: 15px;
            font-weight: bolder;
            color: #1D2129;
            font-family: PingFang SC-Regular, PingFang SC;
        }


        option {
            height: 30px;
        }

        .refresh {
            width: 20px;
            height: 20px;
        }

        .view {
            width: 20px;
            height: 20px;
        }

        .contentDiv {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tableDiv {
            width: 30%;
            height: 100%;
        }

        #tableList {
            background-color: #F2F3F5;
        }

        .search {
            width: 60%;
            justify-content: flex-end;
            height: 90%;
            border: 0px;
            padding-left: 5%;
            position: relative;
        }

        .searchImg {
            position: absolute;
            right: 5%;
            top: 30%;
        }

        #tableName {
            background-color: #F2F3F5;
            border-radius: 4px 4px 4px 4px;
            height: 90%;
            /* width: 104%;*/
            display: inline-block;
            /* margin: 2px;*/
        }

        #tableName:hover {
            background-color: #FFFFFF;
            border: 1px solid #0094FF;
        }

        a:hover {
            color: #ffffff;
        }

        .columnDiv {
            width: 30%;
            height: 100%;
        }

        #columns {
            background-color: #F2F3F5;
        }

        .columns {
            height: 30px;
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
        }

        .columns input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
        }

        #selectAll {
            width: 20px;
            height: 20px;
            margin-right: 10px;
        }

        #selectAll:hover {
            background-color: #FFFFFF;
            border: 1px solid #0094FF;
        }

        .sqlDiv {
            width: 40%;
            height: 100%;
        }

        #ds1 a {
            display: block;
            color: #333;
            padding: 2px;
            line-height: 30px;
            max-height: 30px;
            font-size: 15px;
            transition: all .3s;
        }

        .cka {
            background: #0094FF;
            color: #FFFFFF;
        }

        #ds1 a:hover {
            /*
                        background: rgba(0, 0, 0, .1);
            */
        }

        #dSName {
            background-color: #F2F3F5;
            width: 100%;
            height: 40px;
            border: 1px solid #fff;
            border-radius: 4px 4px 4px 4px;
        }

        #dSName:hover {
            background-color: #FFFFFF;
            border: 1px solid #0094FF;
        }

        #conn {
            background-color: #F2F3F5;
            width: 100%;
            height: 40px;
            border: 0;
            border-radius: 4px 4px 4px 4px;
        }

        #conn:hover {
            background-color: #FFFFFF;
            border: 1px solid #0094FF;
        }

        input:hover {
            /* box-shadow: 0px 0px 1px #44B4FF;*/
            background-color: #FFFFFF;
            border: 1px solid #0094FF;
        }

        select:hover {
            /* box-shadow: 0px 0px 1px #44B4FF;*/
            background-color: #FFFFFF;
            border: 1px solid #0094FF;
        }

        textarea:hover {
            /* box-shadow: 0px 0px 1px #44B4FF;*/
            background-color: #FFFFFF;
            border: 1px solid #0094FF;
        }

        #tableList a {
            display: block;
            padding: 2px;
            line-height: 30px;
            max-height: 30px;
            transition: all .3s;
        }
    </style>
</head>
<body>

<div class="dsDiv" style="width:100%;height:20%;display: flex;align-items: center;justify-content: center;">
    <div style="flex:3;height:100%;width:100%;display: flex;flex-direction: column;align-items: center;">
        <div class="label" style="width:95%;display: flex;justify-content: flex-start;margin-bottom:10px;">
            数据集名称
        </div>
        <div style="width: 95%;">
            <input id="dSName" type="text" name="dSName"/>
        </div>
    </div>
    <div style="flex:3;height:100%;display: flex;align-items: center;justify-content: flex-start;flex-direction: column;">
        <div class="label" style="width:95%;display: flex;justify-content: flex-start;margin-bottom:10px;">
            数据库
        </div>
        <div style="width: 95%;">
            <select id="conn" name="conn" onchange="changeConn()">
            </select>
        </div>
    </div>
    <div style="flex:4;height:100%;display: flex;align-items: center;justify-content: flex-start;flex-direction: column;">
        <div class="label" style="width:95%;display: flex;justify-content: flex-start;margin-bottom:10px;">
            &nbsp;
        </div>
        <div style="display: flex;align-items: center;justify-content: flex-start;">
            <div style="cursor:pointer;height:40px;width:150px;display: flex;background-color: #0094FF;border-radius: 4px;margin-right: 10px;"
                 id="tbfresh">
                <div style="width:75px;display: flex;justify-content: flex-end;align-items: center;padding-right: 5px;">
                    <img src="../../images/design/pages/refresh.png" style="" title="刷新" class="refresh">
                </div>
                <div style="display:flex;align-items:center;color:white;width:75px;padding-left: 5px;">
                    刷新
                </div>
            </div>
            <div style="cursor:pointer;height:40px;width:150px;display: flex;background-color: #0094FF;border-radius: 4px;"
                 id="viewData">
                <div style="display:flex;width:75px;justify-content: flex-end;align-items: center;padding-right: 5px;">
                    <img src="../../images/design/pages/view.png" class="view" title="预览">
                </div>
                <div style="display:flex;align-items:center;width:75px;padding-left: 5px;color:#FFFFFF;">
                    预览
                </div>
            </div>
        </div>
    </div>
</div>

<div class="contentDiv" style="width:100%;height:80%;display: flex;">
    <div class="tableDiv"
         style="flex:3;display: flex;flex-direction: column;align-items: center;justify-content: center;">
        <div class="label" style="width:95%;height:10%;display: flex;align-items: center;justify-content: center;">
            <div style="width: 40%;">
                数据表
            </div>
            <div class="search">
                <input type="text" id="tableName" placeholder="表名" autocomplete="off" class="layui-input">
                <img src="../../images/design/searchTemplate.png" class="searchImg" id="search">
            </div>
        </div>
        <div id="tableList" style="white-space: nowrap;overflow: auto;height: 79%;width:95%;">

        </div>
        <div id="pages" style="white-space: nowrap;overflow-y: hidden;overflow-x:auto;height:10%;width:95%;">

        </div>
    </div>
    <div class="columnDiv"
         style="flex:3;display: flex;align-items: center;justify-content: center;flex-direction: column;height:100%;">
        <div class="label" style="height:10%;width:95%;display: flex;align-items: center;">
            <div style="width:30%;">
                数据表字段
            </div>
            <div style="width:30%;display: flex;align-items: center;justify-content: center;">
                <input type="checkbox" id="selectAll">全选
            </div>
            <div style="width:40%;display: flex;align-items: center;justify-content: flex-end;">
                <button id="generate"
                        style="font-size:14px;cursor:pointer;height:25px;width: 100px;background-color: #0094FF;color:#FFFFFF;border: 0px;">
                    生成SQL
                </button>
            </div>

        </div>
        <div id="columns" style="white-space: nowrap;overflow: auto;height: 89%;width:95%;">
        </div>
    </div>
    <div class="sqlDiv"
         style="flex:4;height:100%;display: flex;align-items: center;justify-content: center;flex-direction: column;">
        <div class="label" style="width:95%;height:10%;display: flex;align-items: center;justify-content: flex-start;">
            数据集获取语句
        </div>
        <div id="sql" style="white-space: nowrap;height: 69%;width:97%;">
            <textarea id="sqlArea">

            </textarea>
        </div>
        <div class="label" style="width:97%;height:10%;display: flex;align-items: center;justify-content: flex-start;">
            数据集描述
        </div>
        <div id="dsMemo" style="height: 10%;width:97%;">
            <textarea
                    style="margin-left:1px;width: 99%;height: 100%;resize: none;font-size: 15px;background-color: #F2F3F5;border:0px;"></textarea>
        </div>
    </div>
</div>
</body>
<script type="text/javascript" src="../../js/jquery-1.11.3.min.js"></script>
<script type="text/javascript" src="../../js/layui.js" charset="utf-8"></script>
<script type="text/javascript" src="../../js/def/global.js"></script>
<script type="text/javascript" src="../../js/codemirror/codemirror.js"></script>
<script type="text/javascript" src="../../js/codemirror/matchbrackets.js"></script>
<script type="text/javascript" src="../../js/codemirror/brace-fold.js"></script>
<script type="text/javascript" src="../../js/codemirror/foldcode.js"></script>
<script type="text/javascript" src="../../js/codemirror/comment-fold.js"></script>
<script type="text/javascript" src="../../js/codemirror/show-hint.js"></script>
<script type="text/javascript" src="../../js/codemirror/anyword-hint.js"></script>
<script type="text/javascript" src="../../js/codemirror/javascript-hint.js"></script>
<script type="text/javascript" src="../../js/codemirror/javascript.js"></script>

<script type="text/javascript">
    let tmp = null;
    let ref; //字段对照
    let connName; //数据源名称
    let form;
    let token = window.sessionStorage.getItem("cur_token");
    let ip = window.sessionStorage.getItem("ef_server_base_url");
    let laypage;
    let editor;
    let dsArray = [];
    let opFlag;
    let curDsName;
    function setTmp(tmps) {
        tmp = tmps;
    }

    function setDsInfo(a, b, c, d) {
        $("#connName").val(a);
        $("input[name='dSName']").val(b);
        $('#sql').find('textarea').val(c);
        $('#dsMemo').find('textarea').val(d);
    }

    function setDsName(dsName) {
        $("#dSName").val(dsName);

        //光标移到开始处
        $('#sql').find('textarea').empty();
        $('#sql').find('textarea').focus();
        $('#sql').find('textarea').trigger('click');
        $('#sql').find('textarea').blur();
        editor.setValue("");

        form.render();
    }

    $(document).ready(function () {

        $('#sql').find('textarea').empty();
        $('#sql').find('textarea').focus();
        $('#sql').find('textarea').trigger('click');
        $('#sql').find('textarea').blur();


        layui.use('form', function () {
            form = layui.form; //只有执行了这一步，部分表单元素才会自动修饰成功
            form.on('select(conn)', function (data) { //选择数据链接操作
                $('#tableList').empty(); //清空表名列表
                connName = data;
            });
        });

        editor = CodeMirror.fromTextArea(document.getElementById("sqlArea"), {
            lineWrapping:"wrap",
            lineNumbers: true,        //是否在编辑器左侧显示行号
            matchBrackets: true,      // 括号匹配
            foldGutter: true,
            mode: "javascript",    //C++
            indentUnit:4,             // 缩进单位为4
            indentWithTabs: true,     //
            smartIndent: true,        //自动缩进，设置是否根据上下文自动缩进（和上一行相同的缩进量）。默认为true。
            styleActiveLine: true,       // 当前行背景高亮
            extraKeys:{"Ctrl-Space":"autocomplete"}//ctrl-space唤起智能提示
        });

        $('.CodeMirror').css('height' , $('#sqlArea').parent().css('height'));

        laypage = layui.laypage;

        //执行一个laypage实例
        laypage.render({
            elem: 'pages' //注意，这里的 test1 是 ID，不用加 # 号
            , prev: '<'
            , count: 0 //数据总数，从服务端得到
            , limit: 100
            , next: '>'
            , groups: 3
        });

        //刷新按钮
        $("#tbfresh").click(function () {
            init(); //重新初始化数据链接
            $("#tableList").empty();
        });
        //预览数据按钮
        $('#viewData').click(function () {
            let sql = editor.getValue();
            let index = layer.open({
                type: 2,
                area: ['750px', '500px'],
                closeBtn: 0,
                shadeClose: true,
                title: false,
                scrollbar: false,
                content: ['dataview.html', 'no'],
                btn: ['关闭'],
                btnAlign: 'c',
                success: function (layero, index) {
                    let iframeWin = window[layero.find('iframe')[0]['name']];
                    let tempParam = window.parent.getParam();
                    iframeWin.setDsInfo($("select[name='conn']").val(),  sql, tmp ,tempParam);
                }
            });
        });
        //
        $("textarea").click(function () {
            startPos = $(this).selectionStart;
        });

        $("#tableName").keyup(function (e) {
            let code = e.keyCode;
            if (code == 13) {
                let v = $("#tableName").val().toLowerCase(); //表名
                if (v != '') {
                    let connName = $('select[name="conn"]').val(); //当前连接名
                    getTbListByKeyword(connName, v); //根据搜索关键字从后台获取表名
                    bindEvent();
                } else {
                    let connName = $('select[name="conn"]').val(); //当前连接名
                    getTbList(connName); //重新获取所有表
                    bindEvent();
                }
            }
        })

        //搜索按钮
        $("#search").click(function () {
            let v = $("#tableName").val().toLowerCase(); //表名
            if (v != '') {
                let connName = $('select[name="conn"]').val(); //当前连接名
                getTbListByKeyword(connName, v); //根据搜索关键字从后台获取表名
                bindEvent();
            } else {
                let connName = $('select[name="conn"]').val(); //当前连接名
                getTbList(connName); //重新获取所有表
                bindEvent();
            }
        });

    });

    //保存数据集信息
    function saveDs() {
        //let sqlStr = $("#sql").find('textarea').val(); //sql语句
        let sqlStr = editor.getValue();
        let sqlMemo = $('#dsMemo').find('textarea').val(); //数据集描述
        let dSName = $("input[name='dSName']").val(); //数据集名
        let connName = $("select[name='conn']").val(); //链接名
        //未设置数据集名称
        if (dSName.trim() == '') {
            layer.msg("请设置数据集名称");
            return false;
        }
        if($.inArray(dSName.trim() , dsArray) != -1){
            if(opFlag == 0){//新增
                layer.msg("存在同名的数据集，请修改数据集名");
                return false;
            }else{ //修改
                if(dSName.trim() != curDsName){ // 未修改数据集名称
                    layer.msg("存在同名的数据集，请修改数据集名");
                    return false;
                }
            }
        }
        let str = "@ \" $ % * \ ) > | ! \\ \/ ? : | + = - ^";
        if (dSName.indexOf('@') > -1 || dSName.indexOf('"') > -1 || dSName.indexOf('$') > -1 || dSName.indexOf('%') > -1 || dSName.indexOf('*') > -1 || dSName.indexOf('\'') > -1
            || dSName.indexOf('!') > -1 || dSName.indexOf('\\') > -1 || dSName.indexOf('\/') > -1 || dSName.indexOf('?') > -1 || dSName.indexOf(':') > -1 || dSName.indexOf('：') > -1
            || dSName.indexOf('|') > -1 || dSName.indexOf('+') > -1 || dSName.indexOf('=') > -1 || dSName.indexOf('-') > -1 || dSName.indexOf('^') > -1) {
            layer.alert("数据集名称不能包含特殊字符<br>" + str, {icon: 2});
            return false;
        }
        //未填写SQL
        if (sqlStr == '') {
            layer.msg("请设置数据集SQL");
            return false;
        }
        let ds = {
            dsSql: sqlStr,
            dsName: dSName,
            connName: connName,
            dsMemo: sqlMemo
        };
        return ds;
    }


    function initByConName(connName) {
        $("select[name='ds']").empty();
        Util.getJsonSub(ip + "/designSys/getDsConnInfo", "get", "", function (data) {
            if (!Util.isNull(data)) {
                let tmp = JSON.parse(data);
                let opt = "<option value='{name}'>{name}</option>";
                $.each(tmp, function (i) {
                    let lis = opt.replace('{name}', tmp[i].name).replace('{name}', tmp[i].name);
                    $("select[name='ds']").append(lis);
                });
                $("select[name='ds']").val(connName);
                renderForm();
            }
        });
    }

    //初始化数据集
    function init(flag , array , dsInfo) {
        opFlag = flag; //操作标识
        $("select[name='conn']").empty(); //清空数据链接
        if (flag == 0) { //新增
            dsArray = array;
            $.ajax({ //请求后台的数据链接信息
                url: ip + "/designSys/getDsConnInfo?token=" + token,
                type: 'get',
                success: function (res) {
                    if (res.state == 'success') {
                        let data = res.data;
                        $.each(data, function (i, e) {
                            if (i == 0) {
                                $("select[name='conn']").append('<option value="' + e.name + '" selected>' + e.name + '</option>')
                            } else {
                                $("select[name='conn']").append('<option value="' + e.name + '">' + e.name + '</option>')
                            }
                        });
                        form.render();
                    }
                }
            })
        } else { //修改数据集
            dsArray = array;
            $.ajax({ //请求后台的数据链接信息
                url: ip + "/designSys/getDsConnInfo?token=" + token,
                type: 'get',
                success: function (res) {
                    if (res.state == 'success') {
                        let data = res.data;
                        $.each(data, function (i, e) {
                            if (i == 0) {
                                $("select[name='conn']").append('<option value="' + e.name + '" selected>' + e.name + '</option>')
                            } else {
                                $("select[name='conn']").append('<option value="' + e.name + '">' + e.name + '</option>')
                            }
                        });
                        $("select[name='conn']").val(dsInfo.ConnName); //数据链接
                        $('input[name="dSName"]').val(dsInfo.DSName); //数据集名称
                        curDsName = dsInfo.DSName;
                        editor.setValue(dsInfo.SqlStr);
                        $('#dsMemo').find('textarea').val(dsInfo.sqlMemo);//备注
                        form.render();
                    }
                }
            })
        }

    }
    let startPos = 0;

    function bindEvent(){
        $('#selectAll').bind('click', function () { //绑定全选事件
            if ($(this).prop('checked') == true) {//$('input:checkbox[name=app]:checked')
                $('#columns').find('input[type="checkbox"]').prop('checked', true);
            } else {
                $('#columns').find('input[type="checkbox"]').prop('checked', false);
            }

        })
        $("#generate").unbind().bind('click', function () {
            let tableName = $('.cka').text();
            //光标移到开始处
            $('#sql').find('textarea').empty();
            $('#sql').find('textarea').focus();
            $('#sql').find('textarea').trigger('click');

            let checkboxs = $('#columns').find('input:checkbox:checked'); //获取所有选中的字段
            if (checkboxs.length == 0) {
                layer.alert('请勾选字段!');
            } else {
                let sql = 'select '
                for (let i = 0; i < checkboxs.length; i++) {
                    if (i != (checkboxs.length - 1)) {
                        sql += (checkboxs[i].value + ',');
                    } else {
                        sql += (checkboxs[i].value);
                    }
                }
                sql += ' from ' + tableName;
                //let val = $("#sql").find('textarea').val(); //获取值
                let val = editor.getValue();; //获取值
                if (val == '') {
                    editor.setValue(sql.trim());
                    //$("#sql").find('textarea').val(sql.trim());
                } else {
                    editor.setValue(val.trim() + '\n' + sql.trim());
                    //$("#sql").find('textarea').val(val.trim() + '\n' + sql.trim());
                }
            }

        })
    }

    //根据数据链接获取所有表
    function getTbList(connName) {
        let url;
        url = ip + "/designSys/getTableList?connName=" + connName + "&tmp=" + tmp + '&token=' + token + '&page=1';
        //清空表名列表
        $("#tableList").empty();
        //清空列
        $("#columns").empty();
        $.ajax({
            url: url,
            type: 'post',
            success: function (res) {
                //读表失败
                if (res.code == 0) {
                    layer.msg(res.text);
                    return;
                }
                let arr = JSON.parse(res.text);
                let total = arr.total;

                if(total == 0){
                    layer.msg("当前数据库没有表");
                    return;
                }

                //执行一个laypage实例
                laypage.render({
                    elem: 'pages' //注意，这里的 test1 是 ID，不用加 # 号
                    , prev: '<'
                    , count: total //数据总数，从服务端得到
                    , limit: 100
                    , next: '>'
                    , groups: 3
                    , curr: 1
                    , jump: function (obj, first) {
                        $('#selectAll').prop('checked' , false);
                        let url1 = ip + "/designSys/getTableList?connName=" + connName + "&tmp=" + tmp + '&token=' + token + '&page=' + obj.curr;
                        $.ajax({
                            url: url1,
                            type: 'post',
                            success: function (res) {
                                //读表失败
                                if (res.code == 0) {
                                    layer.msg(res.text);
                                    return;
                                }

                                //清空表名列表
                                $("#tableList").empty();
                                //清空列
                                $("#columns").empty();

                                let arr1 = JSON.parse(res.text);
                                let tableNames = arr1.page;
                                let li = "<a href='javascript:;'>{tbName}</a>";
                                if (arr.length == 0) {
                                    layer.msg('当前数据库没有表!');
                                } else {
                                    $.each(tableNames, function (i, item) {
                                        let lis = li.replace('{tbName}', item);
                                        $("#tableList").append(lis);
                                    });

                                    $("#tableList a").unbind().bind('click', (function () {
                                        let tableName = $(this).text();
                                        $('#selectAll').prop('checked', false);
                                        $.ajax({
                                            url: ip + "/designSys/getColumn?token=" + token,
                                            type: 'post',
                                            data: {'ConnName': connName, 'tableName': tableName},
                                            success: function (res) {
                                                $('#columns').empty(); //清空
                                                let arr = JSON.parse(res.text);
                                                $.each(arr, function (j, item) {
                                                    $('#columns').append('<div class="columns"><input type="checkbox" value="' + item + '">' + item + '<div>')
                                                });
                                            },
                                            error: function () {

                                            }
                                        })
                                        //添加选中效果
                                        $("#tableList a").each(function () {
                                            $(this).removeClass("cka");
                                        });
                                        $(this).addClass("cka");
                                    }));
                                }

                            }
                        })
                    }
                });

                let tableNames = arr.page;
                let li = "<a href='javascript:;'>{tbName}</a>";
                if (arr.length == 0) {
                    layer.msg('当前数据库没有表!');
                } else {
                    $.each(tableNames, function (i, item) {
                        let lis = li.replace('{tbName}', item);
                        $("#tableList").append(lis);
                    });
                }

                //绑定点击表名事件
                $("#tableList a").unbind().bind('click', (function () {
                    let tableName = $(this).text();
                    $('#selectAll').prop('checked', false);
                    $.ajax({
                        url: ip + "/designSys/getColumn?" + paramStr + "&token=" + token,
                        type: 'post',
                        data: {'ConnName': connName, 'tableName': tableName},
                        success: function (res) {
                            $('#columns').empty(); //清空
                            let arr = JSON.parse(res.text);
                            $.each(arr, function (j, item) {
                                $('#columns').append('<div class="columns"><input type="checkbox" value="' + item + '">' + item + '<div>')
                            });
                        },
                        error: function () {

                        }
                    })
                    //添加选中效果
                    $("#tableList a").each(function () {
                        $(this).removeClass("cka");
                    });
                    $(this).addClass("cka");
                }));

            }
        })
    }

    //根据数据链接获取所有表
    function getTbListByKeyword(connName , keyword) {
        let paramStr = getParamStr();
        let url;
        url = ip + "/designSys/getTableList?connName=" + connName + "&tmp=" + tmp + '&token=' + token + '&page=1&keyword=' + keyword;
        if (paramStr != "{}") {
            url = url + paramStr;
        }
        //清空表名列表
        $("#tableList").empty();
        //清空列
        $("#columns").empty();

        $.ajax({
            url: url,
            type: 'post',
            success: function (res) {
                //读表失败
                if (res.code == 0) {
                    layer.msg(res.text);
                    return;
                }
                let arr = JSON.parse(res.text);
                let total = arr.total;

                //执行一个laypage实例
                laypage.render({
                    elem: 'pages' //注意，这里的 test1 是 ID，不用加 # 号
                    , prev: '<'
                    , count: total //数据总数，从服务端得到
                    , limit: 100
                    , next: '>'
                    , groups: 3
                    , curr: 1
                    , jump: function (obj, first) {
                        $('#selectAll').prop('checked' , false);
                        let paramStr1 = getParamStr();
                        let url1 = ip + "/designSys/getTableList?connName=" + connName + "&tmp=" + tmp + '&token=' + token + '&page=' + obj.curr + '&keyword=' + keyword;
                        if (paramStr1 != "{}") {
                            url1 = url1 + paramStr1;
                        }
                        $.ajax({
                            url: url1,
                            type: 'post',
                            success: function (res) {
                                //读表失败
                                if (res.code == 0) {
                                    layer.msg(res.text);
                                    return;
                                }
                                //清空表名列表
                                $("#tableList").empty();
                                //清空列
                                $("#columns").empty();
                                let arr1 = JSON.parse(res.text);
                                let tableNames = arr1.page;
                                let li = "<a href='javascript:;'>{tbName}</a>";
                                if (arr.length == 0) {
                                    layer.msg('当前数据库没有表!');
                                } else {
                                    $.each(tableNames, function (i, item) {
                                        let lis = li.replace('{tbName}', item);
                                        $("#tableList").append(lis);
                                    });

                                    $("#tableList a").unbind().bind('click', (function () {
                                        let tableName = $(this).text();
                                        $('#selectAll').prop('checked', false);
                                        $.ajax({
                                            url: ip + "/designSys/getColumn?" + paramStr + "&token=" + token,
                                            type: 'post',
                                            data: {'ConnName': connName, 'tableName': tableName},
                                            success: function (res) {
                                                $('#columns').empty(); //清空
                                                var arr = JSON.parse(res.text);
                                                $.each(arr, function (j, item) {
                                                    $('#columns').append('<div class="columns"><input type="checkbox" value="' + item + '">' + item + '<div>')
                                                });
                                            },
                                            error: function () {

                                            }
                                        })
                                        //添加选中效果
                                        $("#tableList a").each(function () {
                                            $(this).removeClass("cka");
                                        });
                                        $(this).addClass("cka");
                                    }));
                                }

                            }
                        })
                    }
                });

                let tableNames = arr.page;
                let li = "<a href='javascript:;'>{tbName}</a>";
                if (arr.length == 0) {
                    layer.msg('当前数据库没有表!');
                } else {
                    $.each(tableNames, function (i, item) {
                        let lis = li.replace('{tbName}', item);
                        $("#tableList").append(lis);
                    });
                }

                //绑定点击表名事件
                $("#tableList a").unbind().bind('click', (function () {
                    let tableName = $(this).text();
                    $('#selectAll').prop('checked', false);
                    $.ajax({
                        url: ip + "/designSys/getColumn?" + paramStr + "&token=" + token,
                        type: 'post',
                        data: {'ConnName': connName, 'tableName': tableName},
                        success: function (res) {
                            $('#columns').empty(); //清空
                            var arr = JSON.parse(res.text);
                            $.each(arr, function (j, item) {
                                $('#columns').append('<div class="columns"><input type="checkbox" value="' + item + '">' + item + '<div>')
                            });
                        },
                        error: function () {

                        }
                    })

                    $('#selectAll').bind('click', function () { //绑定全选事件
                        if ($(this).prop('checked') == true) {//$('input:checkbox[name=app]:checked')
                            $('#columns').find('input[type="checkbox"]').prop('checked', true);
                        } else {
                            $('#columns').find('input[type="checkbox"]').prop('checked', false);
                        }

                    })
                    $("#generate").unbind().bind('click', function () {
                        //光标移到开始处
                        $('#sql').find('textarea').empty();
                        $('#sql').find('textarea').focus();
                        $('#sql').find('textarea').trigger('click');

                        let checkboxs = $('#columns').find('input:checkbox:checked'); //获取所有选中的字段
                        if (checkboxs.length == 0) {
                            layer.alert('请勾选字段!');
                        } else {
                            let sql = 'select '
                            for (let i = 0; i < checkboxs.length; i++) {
                                if (i != (checkboxs.length - 1)) {
                                    sql += (checkboxs[i].value + ',');
                                } else {
                                    sql += (checkboxs[i].value);
                                }
                            }
                            sql += ' from ' + tableName;
                            let val = editor.getValue();; //获取值
                            if (val == '') {
                                //$("#sql").find('textarea').val(sql.trim());
                                editor.setValue(sql.trim());
                            } else {
                                //$("#sql").find('textarea').val(val.trim() + '\n' + sql.trim());
                                editor.setValue(val.trim() + '\n' + sql.trim());
                            }
                        }

                    })
                    //添加选中效果
                    $("#tableList a").each(function () {
                        $(this).removeClass("cka");
                    });
                    $(this).addClass("cka");
                }));

            }
        })
    }
    //切换数据连接
    function changeConn() {
        $('#tableList').empty();
        $('#columns').empty();
        $('#selectAll').prop('checked', false);
        //执行一个laypage实例
        laypage.render({
            elem: 'pages' //注意，这里的 test1 是 ID，不用加 # 号
            , prev: '<'
            , count: 0 //数据总数，从服务端得到
            , limit: 100
            , next: '>'
            , groups: 3
        });
    }

    function getParamStr() {
        let param = window.parent.parent.getParamsJsonStr(); //获取参数
        let paramJson = JSON.parse(param);
        let paramStr = "&";
        let i = 0;
        for (let p in paramJson) {//遍历json对象的每个key/value对,p为key
            i++;
        }
        let j = 0;
        for (let p in paramJson) {
            if (j == (i - 1)) {
                paramStr += p;
                paramStr += "=";
                paramStr += paramJson[p];
            } else {
                paramStr += p;
                paramStr += "=";
                paramStr += paramJson[p];
                paramStr += "&";
            }
        }
        return paramStr;
    }

    //提供给预览页面使用的方法
    function getParamStrP() {
        let param = window.parent.getParamsJsonStr(); //获取参数
        return param;
    }

    function renderForm() {
        layui.use('form', function () {
            var form = layui.form; //只有执行了这一步，部分表单元素才会自动修饰成功
            form.render();

        });
    }
</script>
</html>