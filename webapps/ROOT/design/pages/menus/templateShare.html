<!DOCTYPE html>
<html>   
<head>
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8"/>
    <link rel="stylesheet" href="../../js/css/layui.css">
    <link rel="stylesheet" href="../../css/xadmin.css">
    <style type="text/css">
        .layui-btn{
            background-color: #1e9fff;
        }
    </style>
</head>

<body>
<div class="x-body">
    <div class="layui-row" style="display: flex;align-items: center;justify-content: center;">
        <form class="layui-form layui-col-md12 x-so" style="height: 22px;" onsubmit="return false;">
            <button type="button" id="share" class="layui-btn" title="分享模板"><i class="layui-icon">&#xe613;</i></button>
            <button type="button" id="link" class="layui-btn" title="分享链接"><i class="layui-icon">&#xe64c;</i></button>
        </form>
    </div>
    <table class="layui-hide" id="grid" lay-filter="useruv"></table>
    <script type="text/html" id="opMenuBar">
        <a class="layui-btn layui-btn-sm" lay-event="del" title="删除"><i class="layui-icon">&#xe640;</i></a>
        <!--<a class="layui-btn layui-btn-sm" lay-event="down"><i class="layui-icon">&#xe601;</i></a>-->
    </script>
</div>
</body>
<script type="text/javascript" src="../../js/jquery-1.11.3.min.js"></script>
<script type="text/javascript" src="../../js/layui.js"></script>
<script type="text/javascript">
    var table;
    var filterData = {}; //过滤条件数据
    var ip = window.sessionStorage.getItem("ef_server_base_url");
    var token = window.sessionStorage.getItem("cur_token");
    var ids = [];

    function setFilterData(data){
        filterData = data;
    }

    function getFilterData(){
        return filterData;
    }

    function refresh(){
        layer.closeAll();
        window.location.reload();
    }


    //表格重载
    function reloadTable(data) {
        layer.closeAll();
        table.reload('grid', {
            where: {
                status: data.status,
                operator: data.operator,
                start: data.start,
                end: data.end
            }
        });
    }

    function reloadTableW(){
        table.reload('grid', {});
    }


    layui.use('table', function () {
        table = layui.table;
        table.render({
            elem: '#grid',
            height: 500,
            url: ip + '/designSys/listShareTemplates' + "?t=" + new Date().getTime() + '&token=' + token,
            page: {
                layout: ['prev', 'page', 'next', 'skip'],
                groups: 5,
                first: '<i class="layui-icon">&#xe65a;</i>',
                last: '<i class="layui-icon">&#xe65b;</i>'
            },
            cols: [[ //表头
                {
                    field: 'id',
                    title: 'ID',
                    width: 160
                },
                {
                    field: 'templateId',
                    title: 'templateId',
                    width: 160
                },
                {
                    field: 'userName',
                    title: '被分享用户',
                    width: 160
                },
                {
                    field: 'templateName',
                    title: '模板名',
                    width: 400
                },
                {
                    field: 'isEdit',
                    title: '是否允许修改',
                    width: 150,
                    templet: function (res) {
                        return res.isEdit == '1'?'是':'否'
                    }
                },
                {
                    field: 'RIGHT',
                    title: '操作',
                    width: 220,
                    toolbar: "#opMenuBar"
                }
            ]],
            done: function (res) {
                $("[data-field='id']").css('display', 'none');
                $("[data-field='templateId']").css('display', 'none');
            }
        });

        table.on('tool(useruv)', function (obj) {
            var data = obj.data;
            var layEvent = obj.event;

            if (layEvent === 'del') {
                layer.confirm('确定删除分享模板吗?', function (index) {
                    $.ajax({
                        url: ip + "/designSys/deleteShare?id=" + data.id +  "&token=" + token,
                        type: "POST",
                        success: function (resp) {
                            if (resp.state == 'success') {
                                layer.msg("操作成功", {
                                  time:1000
                                },function () {
                                    table.reload('grid', {});
                                });
                            } else {
                                layer.msg(resp.text);
                            }
                        }
                    });
                });
            }  else if (layEvent === 'down') {
                location.href = encodeURI('${pageContext.request.contextPath}/template/down?name=' + data.NAME + '&path=' + data.PATH + "&t=" + new Date().getTime());
            }
        });

        $('#search').on('click', function () {
            filterData.name = $("input[name=name]").val();
            table.reload('grid', {
                where: {
                    name: $("input[name=name]").val()
                }
            });
        });

        $(document).on('keyup', function (event) {
            if (event.keyCode == 13) {
                table.reload('grid', {
                    where: {
                        name: $("input[name=name]").val()
                    }
                });
            }
        });

    });


    //分享模板
    $('#share').bind('click', function(){
        let index = layer.open({
            type: 2,
            area: ['550px', '480px'],
            closeBtn: 0,
            title: ['分享模板', 'height:30px;line-height:30px'],
            content: ['allocateTemplate.html', 'no'],
            btn: ['确定', '关闭'],
            btnAlign: 'c',
            end: function () {
            },
            success: function (layero, index) {
                let iframeWin = window[layero.find('iframe')[0]['name']];
                iframeWin.init();
            },
            yes: function (index, layero) {
                let iframeWin = window[layero.find('iframe')[0]['name']];
                let res = iframeWin.getShareInfos();
                //无可共享的用户
                if(res.userId == null){
                    layer.msg('没有共享的用户!');
                    return;
                }

                let templateIds = res.templateIds;
                let id = '';
                $.each(templateIds , function (i,e){
                    if(i == templateIds.length - 1){
                        id += e;
                    }else{
                        id += (e + ',');
                    }
                })

                $.ajax({
                    url: ip + '/designSys/shareTemplates?token=' + token,
                    type:'post',
                    data:{
                        userId:res.userId,
                        templateIds:id,
                        isEdit:res.isEdit
                    },
                    success:function(res){
                        if(res.state == 'success'){
                            layer.msg("操作成功", {time:1000}, function () {
                                layer.closeAll();
                                table.reload('grid', {});
                            });
                        }
                    },
                    error:function(){

                    }

                })


            }
        });
    })

    //分享数据链接
    $('#link').bind('click', function(){
        let index = layer.open({
            type: 2,
            area: ['650px', '580px'],
            closeBtn: 0,
            title: ['分享链接', 'height:30px;line-height:30px'],
            content: ['allocateDatasource.html', 'no'],
            btn: ['确定', '关闭'],
            btnAlign: 'c',
            end: function () {
            },
            success: function (layero, index) {
                let iframeWin = window[layero.find('iframe')[0]['name']];
                iframeWin.init();
            },
            yes: function (index, layero) {
                let iframeWin = window[layero.find('iframe')[0]['name']];
                let res = iframeWin.getSharedDatasource(); //获取共享数据链接
                $.ajax({
                    url: ip + '/designSys/shareDataSource?token=' + token,
                    type:'post',
                    data:{
                        sharedDataSource:JSON.stringify(res)
                    },
                    success:function(res1){
                        console.log(res1);
                        if(res1.state == 'success'){
                            layer.msg('操作成功', {time:1000},function(){
                                layer.closeAll();
                            });
                        }
                    },
                    error:function(){

                    }

                })

            }
        });
    })

</script>
</html>