<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="Cache-Control" content="no-cache, no-store">
    <meta http-equiv="expires" content="0">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../../js/css/layui.css">
    <link rel="stylesheet" href="../../css/scroll.css">
    <link rel="stylesheet" href="../../js/zTree/css/zTreeStyle.css" type="text/css">
    <script type="text/javascript" src="../../js/jquery-1.11.3.min.js"></script>
    <script type="text/javascript" src="../../js/zTree/js/jquery.ztree.all.min.js"></script>
    <script type="text/javascript" src="../../js/zTree/js/jquery.ztree.exhide.min.js"></script>
    <script type="text/javascript" src="../../js/layui.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../js/xm-select.js"></script>
    <style>
        select {
            width: 80%;
            height: 30px;
            background-color: #F2F3F5;
            border: none;
            border-radius: 4px;
        }
        select:hover {
            background-color: #FFFFFF;
            border: 1px solid #0094FF;
        }
    </style>
</head>
<body style="padding: 5px;height: 370px">
<!--选择 模板 名称-->
<div>
    <div id="menuDiv" style="width:90%;height:30px;display: flex;justify-content: center;padding:5px;">
        <div style="width: 30%;display: flex;justify-content: flex-end;align-items: center;padding-right: 10px;">
            选择要共享的用户
        </div>
        <div style="width:70%;display: flex;justify-content: flex-start;align-items: center;padding-left: 3px;">
            <select id="design">

            </select>
        </div>
    </div>
    <div style="width:90%;height:30px;display: flex;justify-content: center;padding:5px;">
        <div style="width: 30%;display: flex;justify-content: flex-end;align-items: center;padding-right: 10px;">
            选择要共享的链接
        </div>
        <div style="width:70%;display: flex;justify-content: flex-start;align-items: center;padding-left: 3px;">
            <div id="datasource"
                 style="width:80%;height:30px;background-color:#F2F3F5;border: none;border-radius: 4px; ">

            </div>
        </div>
    </div>
</div>

</body>
<script type="text/javascript">
    var token = window.sessionStorage.getItem("cur_token");
    var ip = window.sessionStorage.getItem("ef_server_base_url");
    var url = ip + '/designSys/getCurUserTemplateZTree?token=' + token;
    var treeObj;
    var allDataSource = [];
    var sharedDataSource = {}; //共享的数据链接


    layui.use('layer', function () {
        var layer = layui.layer;
    });

    function showParent(treeNode, nodes, showList) { //递归显示所有父节点
        showList.push(treeNode.id);
        var parentNode = treeNode.getParentNode();
        if (parentNode == null) { //如果是根节点
            return;
        } else {
            if ($.inArray(parentNode.id, showList) != -1) {  //如果父节点已经显示
                treeObj.showNode(treeNode);//显示当前节点
            } else {
                showList.push(parentNode.id); //将父节点添加到显示结点列表
                treeObj.showNode(parentNode); //显示父节点
                treeObj.hideNodes(parentNode.children);//隐藏父节点的所有子节点
                treeObj.showNode(treeNode);//显示当前节点
                showParent(parentNode, null, showList); //遍历父亲结点
            }

        }
    }

    function initUser() {
        let url1 = ip + '/designSys/getAllDesignUser?token=' + token;
        $.ajax({
            url: url1,
            type: 'get',
            contentType: "application/json;charset=UTF-8",
            success: function (data) {
                let user = data.user; //获取所有用户
                $.each(user, function (i, e) {
                    $('#design').append('<option value="' + e.id + '">' + e.name + '</option>');
                })
                initDataSource();
            }
        });
    }

    //初始化数据链接
    function initDataSource() {
        let url1 = ip + '/designSys/getSharedConnInfoByUser?token=' + token;
        $.ajax({
            url: url1,
            type: 'get',
            contentType: "application/json;charset=UTF-8",
            success: function (data) {
                let dataArray = [];
                sharedDataSource = data.sharedDs;
                allDataSource = data.data; //获取所有的数据链接

                let userId = $('#design').val();
                let curUserDatasource = sharedDataSource[userId]; //当前用户被分享的数据链接

                $.each(allDataSource, function (i, item) {
                    let obj = {
                        name: item.name,
                        value: item.name
                    }
                    if ($.inArray(item.name, curUserDatasource) != -1) {
                        obj['selected'] = true;
                    }
                    dataArray.push(obj);
                });
                //初始化下拉选择框
                select = xmSelect.render({
                    el: '#datasource',
                    theme: {
                        color: '#0094FF',
                    },
                    clickClose: false,
                    direction: 'down',
                    data: dataArray,
                    height: "350px",
                    on: function (data) {
                        let userId = $('#design').val(); //当前共享的用户ID
                        let datasources = [];
                        $.each(data.arr, function (i, e) {
                            datasources.push(e.name);
                        })
                        sharedDataSource[userId] = datasources;
                    }
                })

            }
        });
    }

    function init() {
        initUser();
    }


    $(document).ready(function () {
        $('#design').bind('change', function () {
            let userId = $(this).val(); //被分享的用户ID
            let datasource = sharedDataSource[userId]; //分享的数据链接
            let dataArray = [];
            if (datasource != undefined) { // 重新渲染
                $.each(allDataSource, function (i, item) {
                    let obj = {
                        name: item.name,
                        value: item.name
                    }
                    if ($.inArray(item.name, datasource) != -1) {
                        obj['selected'] = true;
                    }
                    dataArray.push(obj);
                });
                select = xmSelect.render({
                    el: '#datasource',
                    theme: {
                        color: '#0094FF',
                    },
                    clickClose: false,
                    direction: 'down',
                    data: dataArray,
                    height: "350px",
                    on: function (data) {
                        let userId = $('#design').val(); //当前共享的用户ID
                        let datasources = [];
                        $.each(data.arr, function (i, e) {
                            datasources.push(e.name);
                        })
                        sharedDataSource[userId] = datasources;
                    }
                })
            } else { //未分享过数据链接
                $.each(allDataSource, function (i, item) {
                    let obj = {
                        name: item.name,
                        value: item.name
                    }
                    dataArray.push(obj);
                });
                select = xmSelect.render({
                    el: '#datasource',
                    theme: {
                        color: '#0094FF',
                    },
                    clickClose: false,
                    direction: 'down',
                    data: dataArray,
                    height: "350px",
                    on: function (data) {
                        let userId = $('#design').val(); //当前共享的用户ID
                        let datasources = [];
                        $.each(data.arr, function (i, e) {
                            datasources.push(e.name);
                        })
                        sharedDataSource[userId] = datasources;
                    }
                })
            }

        })
    });

    //获取所有共享数据链接
    function getSharedDatasource() {
        return sharedDataSource;
    }

</script>
</html>