<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="Cache-Control" content="no-cache, no-store">
    <meta http-equiv="expires" content="0">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <meta name="format-detection" content="email=no">
    <meta name="format-detection" content="adress=no">
    <link rel="stylesheet" href="../../js/css/layui.css">
    <link rel="stylesheet" href="../../js/css/json-viewer.css">
    <style type="text/css">
        .layui-input, .layui-textarea {
            display: block;
            width: 99%;
            padding-left: 10px;
        }

        #btn_add {
            width: 120px;
            height: 32px;
            background-image: url("../../images/new/btnadd.png");
            background-repeat: no-repeat;
            border: 0px !important;
            padding: 0px;
            margin: 0px;
        }

        .props {
            width: 20%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .props2 {
            width: 20%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .props1 {
            width: 40%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .layui-form-select dl dd.layui-this {
            background-color: #1e9fff;
            color: #fff;
        }

        .hover {
            background-color: #eee;
        }

    </style>
</head>
<body>
<div>
    <div class="layui-tab" style="margin:0px;">
        <ul class="layui-tab-title" id="mainTab">
            <li id="json">页签配置</li>
        </ul>
        <div class="layui-tab-content" style="height:400px;">
            <div class="layui-tab-item layui-show">
                <div style="height:35px;display: flex;align-items: center;justify-content: flex-start;">
                    <div style="margin-right:10px;cursor:pointer;height:35px;width:100px;display: flex;background-color: #0094FF;border-radius: 4px;margin-left: 10px;"
                         id="add">
                        <div style="width:50px;display: flex;justify-content: flex-end;align-items: center;padding-right: 5px;">
                            <img src="../../images/design/pages/add.png" title="添加" class="add"
                                 style="width: 25px;height: 25px;">
                        </div>
                        <div style="display:flex;align-items:center;color:white;width:50px;padding-left: 5px;">
                            新增
                        </div>
                    </div>
                    <div style="cursor:pointer;height:35px;width:100px;display: flex;background-color: #FFFFFF;border-radius: 4px;border: 1px solid #F53F3F;"
                         id="del">
                        <div style="display:flex;width:50px;justify-content: flex-end;align-items: center;padding-right: 5px;">
                            <img src="../../images/design/pages/delete.png" class="delete" title="删除"
                                 style="width: 25px;height: 25px;">
                        </div>
                        <div style="display:flex;align-items:center;color:#F53F3F;width:50px;padding-left: 5px;">
                            删除
                        </div>
                    </div>
                </div>
                <div style="display: flex;height:38px;margin-top: 5px;">
                    <div class="props">页签文本</div>
                    <div class="props1">页签样式</div>
                    <div class="props">关联模板</div>
                    <div class="props">页签背景</div>
                </div>
                <div style="height:322px;border: 1px solid lightgray;margin-top: 5px;overflow: auto" id="container">
                    <div style="display: flex;height:120px;margin-top: 5px;" id="example">
                        <div class="props">
                            <div>
                                <input type="text" name="title" required lay-verify="required"
                                       placeholder="请输入页签名"
                                       autocomplete="off" class="layui-input">
                            </div>
                        </div>
                        <div class="props1">
                            <div style="width: 100%;height: 100%;">
                                 <textarea id="sqlArea" class="layui-textarea" style="width:98%;height:100%">

                                 </textarea>
                            </div>
                        </div>
                        <div class="props">
                            <div style="width:100%;">
                                    <input type="text" style="display:none">
                                    <input type="text" name="title" required lay-verify="required"
                                           placeholder="选择关联的模板"
                                           autocomplete="off" class="layui-input tree">
                            </div>
                        </div>
                        <div class="props2">
                            <div style="height:50%;width:100%;display: flex;align-items: center;justify-content: center;">
                                <button type="button" class="layui-btn uploadBtn" id="upf"
                                        style="background-color: #0094FF">
                                    <i class="layui-icon">&#xe67c;</i>上传图片
                                </button>
                            </div>
                            <div style="height:50%;width:100%;display: flex;align-items: center;justify-content: center;">
                                <img src="" style="display:none;width:100px;height:38px;"/>
                                <input type="text" style="display: none">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div style="display: none;height:120px;margin-top: 5px;" id="exampleC">
    <div class="props">
        <div>
            <input type="text" name="title" required lay-verify="required"
                   placeholder="请输入页签名"
                   autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="props1">
        <div style="width: 100%;height: 100%;">
                                 <textarea id="sqlArea" class="layui-textarea" style="width:98%;height:100%">
                                 </textarea>
        </div>
    </div>
    <div class="props">
        <div style="width:100%;">
            <input type="text" style="display:none">
            <input type="text" name="title" required lay-verify="required"
                   placeholder="选择关联的模板"
                   autocomplete="off" class="layui-input tree">
        </div>
    </div>
    <div class="props2">
        <div style="height:50%;width:100%;display: flex;align-items: center;justify-content: center;">
            <button type="button" class="layui-btn uploadBtn" id="upf"
                    style="background-color: #0094FF">
                <i class="layui-icon">&#xe67c;</i>上传图片
            </button>
        </div>
        <div style="height:50%;width:100%;display: flex;align-items: center;justify-content: center;">
            <img src="" style="display:none;width:100px;height:38px;"/>
            <input type="text" style="display: none">
        </div>
    </div>
</div>
</body>
<script src="../../js/jquery-1.11.3.min.js"></script>
<script src="../../js/layui.js"></script>

<script type="text/javascript">
    let layer;
    let form;
    let base;
    let index = 0;

    function init(a, b, c, d, e, f) {
        base = a;
        let json;
        if (f.columns != undefined) {
            json = f;
        } else {
            json = JSON.parse(f);
        }
        let columns = json.columns;
        if (columns == undefined) { //空插件
            $('#example').find('textarea').val('width:100px;\nheight:60px;\nposition:absolute;\nborder:0px;\nleft:10px;\ntop:10px;');

            layui.use('upload', function () {
                var upload = layui.upload;
                //执行实例
                let uploadInst = upload.render({
                        elem: '#upf'//绑定元素
                        , url: base + '/plugin/uploadFile' // 上传接口，实际使用时改成您自己的上传接口即可。
                        , accept: 'images'
                        , acceptMime: 'image/*' // 打开文件选择器时只显示图片
                        , done: function (res) {
                            //上传完毕回调
                            $('#upf').parent().next().find('img').attr('src', base + '/pluginResource/upload/' + res.message).show();
                            $('#upf').parent().next().find('input').val(res.message)
                            let div = $('#upf').parent().parent(); //example
                            let textarea = div.prev().prev().find('#sqlArea');
                            let text = textarea.val();
                            textarea.val(text + "\nbackground-image:url('@base/" + res.message + "')")
                        }, error: function (res) {
                            //请求异常回调
                            console.log(res);
                        },
                        before: function (obj) {
                            console.log(obj);
                        }
                    })
                ;
            });
        } else {
            $.each(columns, function (i, e) {
                index++;
                if (i == 0) {
                    let div = $('#example');
                    let props = div;
                    let propsDiv = props.children();
                    $.each(propsDiv, function (ii, ee) {
                        if (ii == 0) { //列名
                            $(ee).find('input').val(e.name);
                        } else if (ii == 1) { //显示名
                            $(ee).find('textarea').val(e.css);
                        } else if (ii == 2) { //列宽
                            $(ee).find('input').eq(0).val(e.id);
                            $(ee).find('input').eq(1).val(e.template);
                        } else if (ii == 3) {
                            let div = $(ee).find('div').eq(1);
                            if (e.src != undefined) {
                                div.find('input').val(e.src);
                                div.find('img').attr('src', base + '/pluginResource/upload/' + e.src).show();
                            }
                        }
                    })

                    layui.use('upload', function () {
                        var upload = layui.upload;
                        //执行实例
                        let uploadInst = upload.render({
                            elem: '#upf' //绑定元素
                            , url: base + '/plugin/uploadFile' // 上传接口，实际使用时改成您自己的上传接口即可。
                            , accept: 'images'
                            , acceptMime: 'image/*' // 打开文件选择器时只显示图片
                            , done: function (res) {
                                //上传完毕回调
                                $('#upf').parent().next().find('img').attr('src', base + '/pluginResource/upload/' + res.message).show();
                                $('#upf').parent().next().find('input').val(res.message)
                                let div = $('#upf').parent().parent(); //example
                                let textarea = div.prev().prev().find('#sqlArea');
                                let text = textarea.val();
                                textarea.val(text + "\nbackground-image:url('@base/" + res.message + "')")
                            }
                            , error: function (res) {
                                //请求异常回调
                                console.log(res);
                            },
                            before: function (obj) {
                                console.log(obj);
                            }
                        });
                    });

                } else {
                    let div = $('#exampleC').clone();
                    div.css('display', 'flex');
                    $('#container').append(div);
                    div.attr("id", "example_" + i);
                    div.find('.uploadBtn').attr("id", "upf_" + i)
                    let props = div;
                    let propsDiv = props.children();
                    $.each(propsDiv, function (ii, ee) {
                        if (ii == 0) { //列名
                            $(ee).find('input').val(e.name);
                        } else if (ii == 1) { //显示名
                            $(ee).find('textarea').val(e.css);
                        } else if (ii == 2) { //列宽
                            $(ee).find('input').eq(0).val(e.id);
                            $(ee).find('input').eq(1).val(e.template);
                        } else if (ii == 3) {
                            let div = $(ee).find('div').eq(1);
                            if (e.src != undefined) {
                                div.find('input').val(e.src);
                                div.find('img').attr('src', base + '/pluginResource/upload/' + e.src).show();
                            }
                        }
                    })
                }


                layui.use('upload', function () {
                    var upload = layui.upload;
                    //执行实例
                    let uploadInst = upload.render({
                        elem: '#upf_' + i //绑定元素
                        , url: base + '/plugin/uploadFile' // 上传接口，实际使用时改成您自己的上传接口即可。
                        , accept: 'images'
                        , acceptMime: 'image/*' // 打开文件选择器时只显示图片
                        , done: function (res) {
                            //上传完毕回调
                            $('#upf_' + i).parent().next().find('img').attr('src', base + '/pluginResource/upload/' + res.message).show();
                            $('#upf_' + i).parent().next().find('input').val(res.message)
                            let div = $('#upf_' + i).parent().parent(); //example
                            let textarea = div.prev().prev().find('#sqlArea');
                            let text = textarea.val();
                            textarea.val(text + "\nbackground-image:url('@base/" + res.message + "')")
                        }
                        , error: function (res) {
                            //请求异常回调
                            console.log(res);
                        },
                        before: function (obj) {
                            console.log(obj);
                        }
                    });
                });

            })
        }


        $('#add').unbind().bind('click', function () {
            index++;
            let clone = $('#exampleC').clone();
            clone.css('display', 'flex');
            clone.attr('id', 'example_' + index);
            clone.find('textarea').val('width:100px;\nheight:60px;\nposition:absolute;\nborder:0px;\nleft:10px;\ntop:10px;');
            clone.find('.uploadBtn').attr("id", "upf_" + index);
            $('#container').append(clone);
            $('#container').children().removeClass('hover');
            clone.addClass('hover');
            clone.find('input').unbind().bind('focus', function () {
                $('#container').children().removeClass('hover');
                $(this).parent().parent().parent().addClass('hover');
                if ($(this).attr('class') == 'layui-input tree') {
                    let input = $(this);
                    let index = layer.open({
                        type: 2,
                        area: ['350px', '480px'],
                        closeBtn: 0,
                        title: ['选择关联的模板', 'height:30px;line-height:30px'],
                        content: ['../menus/chooseTemplate.html', 'no'],
                        btn: ['确定', '关闭'],
                        btnAlign: 'c',
                        end: function () {
                        },
                        success: function (layero, index) {
                            let iframeWin = window[layero.find('iframe')[0]['name']];
                            iframeWin.init();
                        },
                        yes: function (index, layero) {

                            let iframeWin = window[layero.find('iframe')[0]['name']];
                            let res = iframeWin.getRes();
                            input.val(res.name);
                            input.prev().val(res.id);
                            layer.closeAll();
                            return false;
                        }
                    });
                }
            })

            layui.use('upload', function () {
                var upload = layui.upload;
                //执行实例
                let uploadInst = upload.render({
                    elem: '#upf_' + index //绑定元素
                    , url: base + '/plugin/uploadFile' // 上传接口，实际使用时改成您自己的上传接口即可。
                    , accept: 'images'
                    , acceptMime: 'image/*' // 打开文件选择器时只显示图片
                    , done: function (res) {
                        //上传完毕回调
                        $('#upf_' + index).parent().next().find('img').attr('src', base + '/pluginResource/upload/' + res.message).show();
                        $('#upf_' + index).parent().next().find('input').val(res.message)
                        let div = $('#upf_' + index).parent().parent(); //example
                        let textarea = div.prev().prev().find('#sqlArea');
                        let text = textarea.val();
                        textarea.val(text + "\nbackground-image:url('@base/" + res.message + "')")
                    }
                    , error: function (res) {
                        //请求异常回调
                        console.log(res);
                    },
                    before: function (obj) {
                        console.log(obj);
                    }
                });
            });
        })

        $('#del').unbind().bind('click', function () {
            $('.hover').remove();
        })

        $('input[type="text"]').unbind().bind('focus', function () {
            $('#container').children().removeClass('hover');
            $(this).parent().parent().parent().addClass('hover');
            if ($(this).attr('class') == 'layui-input tree') {
                let input = $(this);
                let index = layer.open({
                    type: 2,
                    area: ['350px', '480px'],
                    closeBtn: 0,
                    title: ['选择关联的模板', 'height:30px;line-height:30px'],
                    content: ['../menus/chooseTemplate.html', 'no'],
                    btn: ['确定', '关闭'],
                    btnAlign: 'c',
                    end: function () {
                    },
                    success: function (layero, index) {
                        let iframeWin = window[layero.find('iframe')[0]['name']];
                        iframeWin.init();
                    },
                    yes: function (index, layero) {

                        let iframeWin = window[layero.find('iframe')[0]['name']];
                        let res = iframeWin.getRes();
                        input.val(res.name);
                        input.prev().val(res.id);
                        layer.closeAll();
                        return false;
                    }
                });
            }
        })

        /*  layui.use('form', function () {
              form = layui.form;
              form.render();
          });

          form.render();*/
    }

    layui.use('layer', function () {
        layer = layui.layer;
    });


    /**
     * Created by whj on 2019/9/10.
     */
    let plugin = {
        optionJson: {},
        util: {
            isPositiveNumber: function (num) { //判断是否是正整数
                var g = /^[1-9]*[1-9][0-9]*$/;
                return g.test(num);
            },
            isNoNegativeNumber: function (num) {
                var g = /^[1-9]*[1-9][0-9]*$/;
                if (g.test(num)) {
                    return true;
                } else {
                    if (num == 0) {
                        return true;
                    } else {
                        return false;
                    }
                }
            },
            isPercentNumber: function (num) { //是否是百分整数
                var g = new RegExp(/^\d+%$/); //不包含小数
                //new RegExp(/^\d+\.{0,1}\d+%$/); //包含小数
                if (g.test(num)) {
                    return true;
                } else {
                    if (num == 0) {
                        return true;
                    } else {
                        return false;
                    }
                }
            },
            isRotateNumber: function (num) {
                var g = /^[1-9]*[1-9][0-9]*$/;
                var g1 = /^-[1-9]*[1-9][0-9]*$/;
                if (g.test(num)) { //是正整数
                    if (num <= 90) {
                        return true;
                    } else {
                        layer.alert("请输入-90到90间整数!");
                        return false;
                    }
                } else if (g1.test(num)) {
                    if (num >= -90) {
                        return true;
                    } else {
                        layer.alert("请输入-90到90间整数!");
                        return false;
                    }
                } else if (num == 0) {
                    return true;
                }
            },
        },
        bind: function () {

        },
        init: function () {

        },
        initTheme: function (theme) {

        },
        initByJson: function (json) {

        },
        initStyle: function (json) {

        }
    }

    function getOptions() {
        let children = $('#container').children(); //获取表头配置内容
        let option = {};
        let columns = [];
        $.each(children, function (i, e) {
            let column = {};
            let props = $(e).children();
            let propsDiv = props.children();
            $.each(propsDiv, function (ii, ee) {
                if (ii == 0) { //标签名
                    column.name = $(ee).find('input').val();
                } else if (ii == 1) { //css样式
                    column.css = $(ee).find('textarea').val();
                } else if (ii == 2) { //对应的模板名和id
                    column.id = $(ee).find('input').eq(0).val();
                    column.template = $(ee).find('input').eq(1).val();
                } else if (ii == 3) {

                } else if (ii == 4) {
                    let flag = column.css.indexOf("@base");
                    if (flag != -1) {
                        if ($(ee).find('input').val() != '') {
                            column.src = $(ee).find('input').val();
                        }
                    }
                }
            })
            columns.push(column);
        })
        option.columns = columns;
        option.initTimes = 1;
        return option;
    }
</script>
</html>