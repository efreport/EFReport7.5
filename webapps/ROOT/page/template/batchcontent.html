<!DOCTYPE html>
<html>  
<head>
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8"/>
    <link rel="stylesheet" href="../../lib/layui-v2.7.6/css/layui.css" media="all">
    <link rel="stylesheet" href="../../js/zTree/css/zTreeStyle.css" type="text/css">
    <style>
        .redspan {
            color: red;
        }

        .layui-form-checked[lay-skin=primary] i {
            border-color: #0094FF!important;
            background-color: #0094FF;
        }

        .layui-form-select dl dd.layui-this {
            background-color: #0094FF !important;
        }
        .layui-form-select dl dd:hover {
            background-color: #0094FF !important;
        }

        /* 设置滚动条样式 */
        ::-webkit-scrollbar {
            width: 4px;
            height: 1px;
        }
        /* 设置滚动条样式 */
        ::-webkit-scrollbar-thumb {
            border-radius: 10px;
            box-shadow: inset 0 0 5px rgba(97, 184, 179, 0.1);
            background: #d5d5d5;
        }
        /* 设置滚动条样式 */
        ::-webkit-scrollbar-track {
            box-shadow: inset 0 0 5px rgba(87, 175, 187, 0.1);
            border-radius: 10px;
            background: #ffffff;
        }

        /* 修改radio选中状态的颜色信息 */
        .layui-form-radio:hover *, .layui-form-radioed, .layui-form-radioed > i {
            color: #0094FF !important;
        }
        .layui-form-checked span, .layui-form-checked:hover span {
            background: #0094FF !important;
        }


        /**ztree字体**/
        #tempTree li a {
            padding: 1px 3px 0 0;
            margin: 0;
            cursor: pointer;
            height: 17px;
            color: #4E5969;
            background-color: transparent;
            text-decoration: none;
            vertical-align: top;
            display: inline-block;
        }

        #tempTree li span{
            vertical-align: top;
        }

        #tempTree li span.button {
            width: 16px !important;
            height: 16px !important;
        }

        #tempTree li span.button.chk {
            width: 13px !important;
            height: 13px !important;
        }

    </style>
</head>
<body>
<div class="x-body layui-anim layui-anim-up">
    <div style="height: 30px;"></div>
    <form id="main" class="layui-form">
        <input type="hidden" name="id" value="0">
        <input type="hidden" name="tempIds" />

        <div style="position: relative; width: 700px; height: auto; margin: auto;">
            <div style="width: 320px; height: 400px;float: left;">
                <div style="width: 300px;padding-left: 20px;">
                    <input type="text" name="tempnames" placeholder="请选择模板" class="layui-input" readonly="readonly" />
                </div>
                <ul id="tempTree" class="ztree"
                    style="width:280px; height: 250px;overflow: auto;white-space: normal;touch-action: pan-x;padding:20px;"></ul>
            </div>
            <div style="width: 50%; height: 400px;float: left;">

                <div class="layui-form-item">
                    <label class="layui-form-label" style="width: 100px;">
                        <span class="redspan">*</span>角色
                    </label>
                    <div class="layui-input-inline" style="width: 200px;">
                        <input type="hidden" name="roleId">
                        <input type="text" name="role_name" lay-verify="required" class="layui-input" readonly="readonly">
                        <div id="div_role_tree"
                            style="position: absolute; display: none; z-index: 9999; background-color: #F5F7F8;">
                            <div id="role_tree" class="demo-tree demo-tree-box" style="width: 200px;height: 160px; overflow-y: auto;"></div>
                        </div>
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label" style="width: 100px;">
                        <span class="redspan">*</span>状态
                    </label>
                    <div class="layui-input-inline" style="width: 200px;">
                        <input type="radio" name="status" value="0" title="禁用">
                        <input type="radio" name="status" value="1" checked title="正常">
                    </div>
                </div>


                <div class="layui-form-item">
                    <label class="layui-form-label" style="width: 100px;">
                        <span class="redspan">*</span>是否公开
                    </label>
                    <div class="layui-input-inline" style="width: 200px;">
                        <input type="radio" name="open" value="Y" title="是">
                        <input type="radio" name="open" value="N" checked title="否">
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label" style="width: 100px;">
                        <span class="redspan">*</span>是否缓存模板
                    </label>
                    <div class="layui-input-inline" style="width: 200px;">
                        <input type="radio" name="cache" value="Y" lay-filter="cache" title="是">
                        <input type="radio" name="cache" value="N" lay-filter="cache" checked title="否">
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label" style="width: 100px;">
                        <span class="redspan">*</span>缓存时间(小时)
                    </label>
                    <div class="layui-input-inline" style="width: 200px;">
                        <input type="text" name="cache_time"  class="layui-input" value="24" disabled >
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label" style="width: 100px;">
                        <span class="redspan">*</span>终端
                    </label>
                    <div class="layui-input-inline" style="width: 200px;">
                        <input type="checkbox" name="clientType" value="01" title="PC" checked>
                    <input type="checkbox" name="clientType" value="10" title="Mobile">
                    </div>
                </div>
            </div>
            <div style="clear:both;"></div>
        </div>

        <div style="position: relative; width: 750px; height: auto; margin: auto; text-align: center;">
            <button class="layui-btn layui-btn-normal" lay-filter="add" lay-submit="">
                保存
            </button>
        </div>
        <div style="position: relative; width: 750px; height: 20px; margin: auto;"></div>
    </form>
</div>
</body>
<script src="../../lib/jquery-3.4.1/jquery-3.4.1.min.js"></script>
<script type="text/javascript" src="../../js/zTree/js/jquery.ztree.all.min.js"></script>
<script src="../../lib/layui-v2.7.6/layui.js" charset="utf-8"></script>
<script src="../../js/common.js" charset="utf-8"></script>

<script type="text/javascript">

    var base = window.sessionStorage.getItem("ef_server_base_url");
    var token = window.sessionStorage.getItem("cur_token");
    var pageRoleAry = [];
    var treeObj;

    var form;
    var tree;
    layui.use(['tree', 'form', 'layer', 'upload', 'element'], function () {
        $ = layui.jquery;
        form = layui.form, layer = layui.layer;
        tree = layui.tree;

        var upload = layui.upload
        ,element = layui.element;

        form.on('radio(cache)', function(data){
            if(data.value == 'Y'){
                $('input[name="cache_time"]').attr('disabled' , false);
            }else{
                $('input[name="cache_time"]').attr('disabled' , true);
            }
        });


        form.on('submit(add)', function (data) {

            let roleId = $("input[name='roleId']").val();
            if (roleId.trim() === "") {
                efalert(layer , '请至少选择一个角色！' , 2);
                return false;
            }

            var $clientType = $("input[name='clientType']:checked"), clientTypeVal = 0;
            if (0 === $clientType.length) {
                efalert(layer , '请至少选择一个终端！' , 2);
                return false;
            } else {
                $clientType.each(function () {
                    clientTypeVal += parseInt($(this).val());
                });
                if (clientTypeVal === 1) {
                    clientTypeVal = "01";
                }
                clientTypeVal = "" + clientTypeVal;
            }
            if(data.field.cache == 'Y'){
                if(data.field.cache_time == ''){
                    efalert(layer , '请输入缓存时间' , 2);
                }
            }
            let checked_nodes = treeObj.getCheckedNodes(true);
            let data_tempIds_ary = [];
            for (let k=0;k<checked_nodes.length;k++) {
                if (checked_nodes[k].type === "temp") {
                    data_tempIds_ary.push(checked_nodes[k].id);
                }
            }
            let param = {
                tempIds: data_tempIds_ary.join(","), 
                status: data.field.status,
                isOpen: data.field.open,
                isCache: data.field.cache,
                cacheTime: data.field.cache_time,
                clientType: clientTypeVal,
                roleId: data.field.roleId
            }

            jQuery.ajax({
                    url: base + "/template/batchUpdateNew?token=" + token,
                    type: "POST",
                    data: param,
                    success: function (resp) {
                        if (resp.state === "success") {
                            efalert(layer , resp.message , 6);
                            let cur_timer = window.setInterval(function() {
                                var index = parent.layer.getFrameIndex(window.name);
                                parent.layer.close(index);
                                parent.reloadTableW();
                                window.clearInterval(cur_timer);
                            }, 1500);
                        } else {
                            efalert(layer , resp.message, 2);
                        }
                    },
                    error: function () {
                        var url = '/home_index.html';
                        window.location.href = url;
                    }
                });
            return false;
        });
    
    
    });

    // 去掉重复项
    let removeRepeat = function(arys) {
        return Array.from(new Set(arys));
    }

    var setting = {
            callback: {
                beforeDrag: function() {return false;},
                beforeDrop: function() {return false;},
                onCheck: function(event, treeId, treeNode) {
                    if (treeNode.children === undefined || treeNode.children === "" || treeNode.children.length === 0) {
                        let tempidstr = $("input[name='tempIds']").val();
                        let tempnamestr = $("input[name='tempnames']").val();
                        let obj = treeNode;
                        if(obj.checked === true) {
                            // 勾选，结果为true
                            let id = obj.id;
                            let name = obj.name;
                            let idAry = [];
                            if (tempidstr.length > 0) {
                                idAry = tempidstr.split(",");
                                idAry.push(id);
                            } else {
                                idAry.push(id);
                            }
                            idAry = removeRepeat(idAry);
                            tempidstr = idAry.join(",");
                            $("input[name='tempIds']").val(tempidstr);

                            let nameAry = [];
                            if (tempnamestr.length > 0) {
                                nameAry = tempnamestr.split(",");
                                nameAry.push(name);
                            } else {
                                nameAry.push(name);
                            }
                            nameAry = removeRepeat(nameAry);
                            tempnamestr = nameAry.join(",");
                            $("input[name='tempnames']").val(tempnamestr);

                        } else {
                            // 取消勾选
                            let id = obj.id;
                            let name = obj.name;
                            let idAry = [];
                            if (tempidstr.length > 0) {
                                idAry = tempidstr.split(",");
                                let newIdAry = [];
                                for (let i = 0; i < idAry.length; i++) {
                                    if (parseInt(idAry[i]) === id) {
                                        continue;
                                    }
                                    newIdAry.push(idAry[i]);
                                }
                                idAry = newIdAry;
                            }
                            idAry = removeRepeat(idAry);
                            tempidstr = idAry.join(",");
                            $("input[name='tempIds']").val(tempidstr);

                            let nameAry = [];
                            if (tempnamestr.length > 0) {
                                nameAry = tempnamestr.split(",");
                                let newNameAry = [];
                                for (let i = 0; i < nameAry.length; i++) {
                                    if (nameAry[i] === name) {
                                        continue;
                                    }
                                    newNameAry.push(nameAry[i]);
                                }
                                nameAry = newNameAry;
                            }
                            nameAry = removeRepeat(nameAry);
                            tempnamestr = nameAry.join(",");
                            $("input[name='tempnames']").val(tempnamestr);
                        }

                    }


                }
            },
            view: {
                showLine: true,
                showIcon: true,
                selectedMulti: false
            },
            check: {
                enable: true,
                chkStyle: "checkbox",
                chkboxType: {
                    "Y":"ps",
                    "N":"ps"
                }
            }
        };

    $(function(){
        let url=base+"/template/getTempTreeByCompany?token="+token;
        $.ajax({
            url: url,
            type: 'get',
            contentType: "application/json;charset=UTF-8",
            success: function (data) {
                if (data.state === "success") {
                    let cData = data.data;
                    treeObj = $.fn.zTree.init($("#tempTree"), setting, cData);
                    treeObj.expandAll(true);

                } else if (data.state === "nodata") {
                    // 无数据
                } else if (data.state === "failed") {
                    // 出错误了
                }
            }
        });
    });



    $(function () {

        $("input[name='cache_time']").change(function () {
            var val = $(this).val();
            var g = /^[1-9]*[1-9][0-9]*$/;
            if(g.test(val)){
                if(val<1 || val>24){
                    efalert(layer , '请输入1-24之间的数字' , 2);
                    $(this).val(24);
                }
            }else{
                efalert(layer , '请输入1-24之间的数字' , 2);
                $(this).val(24);
            }
        });

        $.ajaxSetup({
            async: false
        });
   

        // 角色
        $("input[name='role_name']").click(function (e) {
            if ($("#div_type_tree").is(":visible")) $("#div_type_tree").hide();
            $("#div_role_tree").show();

            e.stopPropagation();

            $("body").click(function (e) {
                var elem = e.target;
                while (elem) {
                    if (elem.tagName == 'DIV' && elem.id === "div_role_tree") {
                        return;
                    }
                    elem = elem.parentNode;
                }
                $("#div_role_tree").hide();
            });
        });

        $.get(base + "/role/list?token=" + token, function (res) {
            let ary = res.data;
            for (let i = 0; i < ary.length; i++) {
                ary[i].title = ary[i].name;
            }
            let roleStr = $("input[name='roleId']").val();
            if (roleStr !== "") {
                let idArys = roleStr.split(",");
                let nameArys = [];
                for (let i = 0; i < ary.length; i++) {
                    for (let j = 0; j < idArys.length; j++) {
                        if (ary[i].id === parseInt(idArys[j])) {
                            ary[i].checked = true;
                        }
                    }
                }
            }
            pageRoleAry = ary;
            initRoleTree(ary);
        });

    });

    let initRoleTree = function(roledata) {
        //常规用法
        tree.render({
            elem: '#role_tree' //默认是点击节点可进行收缩
            ,data: roledata
            ,showCheckbox: true
            ,accordion: true
            ,oncheck: function(obj){
                let roleidstr = $("input[name='roleId']").val();
                let rolenamestr = $("input[name='role_name']").val();
                if (obj.checked === true) {
                    let id = obj.data.id;
                    let name = obj.data.name;
                    let idAry = [];
                    if (roleidstr.length > 0) {
                        idAry = roleidstr.split(",");
                        idAry = Array.from(new Set(idAry));
                        idAry.push(id);
                        idAry = Array.from(new Set(idAry));
                    } else {
                        idAry.push(id);
                    }
                    

                    let new_id_ary = Array.from(new Set(idAry));

                    if (new_id_ary.length>0) {
                        for (jk =0 ;jk < new_id_ary.length; jk++) {
                            new_id_ary[jk] = parseInt(new_id_ary[jk]);
                        }
                    }

                    new_id_ary = Array.from(new Set(new_id_ary));

                    let newstr_roleidstr = new_id_ary.join(",");

                    $("input[name='roleId']").val(newstr_roleidstr);

                    let nameAry = [];
                    if (rolenamestr.length > 0) {
                        nameAry = rolenamestr.split(",");
                        nameAry = Array.from(new Set(nameAry));
                        nameAry.push(name);
                        nameAry = Array.from(new Set(nameAry));
                    } else {
                        nameAry.push(name);
                    }

                    let new_name_ary = Array.from(new Set(nameAry));
                    rolenamestr = new_name_ary.join(",");
                    $("input[name='role_name']").val(rolenamestr);
                } else {
                    let id = obj.data.id;
                    let name = obj.data.name;
                    let idAry = [];
                    if (roleidstr.length > 0) {
                        idAry = roleidstr.split(",");
                        let newIdAry = [];
                        for (let i = 0; i < idAry.length; i++) {
                            if (parseInt(idAry[i])  === parseInt(id)) {
                                continue;
                            }
                            newIdAry.push(idAry[i]);
                        }
                        idAry = newIdAry;
                        idAry = Array.from(new Set(idAry));
                    }
                    let new_id_ary = Array.from(new Set(idAry));

                    if (new_id_ary.length>0) {
                        for (jk =0 ;jk < new_id_ary.length; jk++) {
                            new_id_ary[jk] = parseInt(new_id_ary[jk]);
                        }
                    }
                    new_id_ary = Array.from(new Set(new_id_ary));
                    roleidstr = new_id_ary.join(",");
                    $("input[name='roleId']").val(roleidstr);
                    let nameAry = [];
                    if (rolenamestr.length > 0) {
                        nameAry = rolenamestr.split(",");
                        let newNameAry = [];
                        for (let i = 0; i < nameAry.length; i++) {
                            if (nameAry[i] === name) {
                                continue;
                            }
                            newNameAry.push(nameAry[i]);
                        }
                        nameAry = newNameAry;
                        nameAry = Array.from(new Set(nameAry));
                    }
                    let new_name_ary = Array.from(new Set(nameAry));
                    rolenamestr = new_name_ary.join(",");
                    $("input[name='role_name']").val(rolenamestr);
                }
            }
        });
    }

</script>

</html>