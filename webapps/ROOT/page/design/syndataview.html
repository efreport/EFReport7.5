<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="Cache-Control" content="no-cache, no-store">
    <meta http-equiv="expires" content="0">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../../lib/layui-v2.7.6/css/layui.css" media="all">
    <style type="text/css">
        img:hover {
            background-color: #D5D5D5;
            border-radius: 2px;
            cursor: pointer;
        }
        .layui-laypage-em {
            background-color: #0094FF !important;
        }

        .refresh {
            width: 20px;
            height: 20px;
        }
    </style>
</head>
<body style="overflow:hidden;">
<div style="margin: 10px 0 0 10px">
    预览行数：<input type="text" name="count" value="10" onkeyup="this.value=this.value.replace(/\D/g,'')" onafterpaste="this.value=this.value.replace(/\D/g,'')">
    <!-- <img src="../../images/design/pages/refresh.png" style="width:16px;height:16px;" title="刷新"> -->

    <div style="cursor:pointer;width:50px;height:30px;display: flex;justify-content: center;align-items: center;background-color: #0094FF;" id="refre">
        <img src="../../images/design/pages/refresh.png" title="刷新" class="refresh">
    </div>
</div>
<table id="data" lay-filter="data"></table>
<input type="hidden" id="sql">
<input type="hidden" id="tmp">
<input type="hidden" id="cn">
</body>
<script src="../../lib/jquery-3.4.1/jquery-3.4.1.min.js"></script>
<script src="../../lib/layui-v2.5.5/layui.js" charset="utf-8"></script>
<script src="../../js/common.js" charset="utf-8"></script>
<script type="text/javascript">
    var base = '';
    var token = '';
    var sql='';

    $(function(){
        let server_base_url = window.sessionStorage.getItem("ef_server_base_url");
        base = server_base_url;
        let tokn = window.sessionStorage.getItem("cur_token");
        token = tokn;
    });

    function getUrl(){
        var url =   base + "/designSys/getdataList?token="+token+"&ConnName="+$("#cn").val()+"&sql="+sql+"&tmp="+$("#tmp").val()+"&count="+$("input[name='count']").val()+"&t="+new Date().getTime();
        return url;
    }
    function setDsInfo(a,b,c){
        $("#cn").val(a);
        $("#tmp").val(c);
        sql=encodeURIComponent(b);
        sql=sql.replace('select','_sel_');
        layui.use('table', function(){
            var table = layui.table;
            $('img').click(function(){
                table.reload('data', {
                    url: getUrl()
                    ,page:false
                    ,method:'post'
                    ,cols: [[]]
                    ,done:function(res){
                        // console.log("res--->", res);
                        // debugger;
                        show(res);
                    }
                });
            });
            //第一个实例
            table.render({
                elem: '#data'
                ,method:'post'
                ,page:{limit:Number.MAX_VALUE}
                ,loading:true
                ,url: getUrl()
                ,cols: [[]]
                ,done:function(res){
                    // console.log("res--->", res);
                    // debugger;
                    show(res);
                }
            });
            function show(res){
                // debugger;
                if (res.text === "") {
                    // 如果返回的结果为 ""
                    return;
                }
                var data = JSON.parse(res.text);
                var list = [];
                var len=data.length;
                $.each(data,function(i,v){
                    var x=0;
                    for(var key in v){
                        list[x]={field:key, title:key, align:'center',width:100};
                        x++;
                    }
                });
                table.init('data',{
                    height: 300
                    ,limits:[len]
                    ,limit:len
                    ,page:{limit:len}
                    ,size: 'sm'
                    ,cols:[list]
                    ,data:data
                });
            }
        });
    }

</script>
</html>