<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="../../../lib/jquery-3.4.1/jquery-3.4.1.min.js" charset="utf-8"></script>
    <script src="../../../lib/layui-v2.5.5/layui.js" charset="utf-8"></script>
    <link rel="stylesheet" href="../../../lib/layui-v2.5.5/css/layui.css" media="all">
    <title>Document</title>
    <style>
        .layui-form-checked[lay-skin=primary] i {
            border-color: #0094FF!important;
            background-color: #0094FF;
        }

        .layui-form-select .layui-input {
            background-color: #f2f3f5 !important;
        }
        .layui-form-select dl dd.layui-this {
            background-color: #0094FF !important;
        }
        .layui-form-select dl dd:hover {
            background-color: #0094FF !important;
        }
    </style>
</head>
<body>
    <div>
        <input type="hidden" name="roleId" />
        <input type="hidden" name="role_name" />
        <div id="role_tree" class="demo-tree demo-tree-box"></div>
    </div>
</body>
<script>
    
    layui.use(['tree', 'util', 'form'], function(){
        var tree = layui.tree
        ,layer = layui.layer
        ,util = layui.util;
        form = layui.form;
        let loadrole = function() {
            // 加载权限树
            let server_base_url = window.sessionStorage.getItem("ef_server_base_url");
            let token = window.sessionStorage.getItem("cur_token");
            // console.log("当前token--->", token);
            let efurl = server_base_url + "/role/list?token=" + token;
            $.ajax({
                url: efurl,
                type: 'get',
                success: function (res) {
                    // console.log("角色数据结果集为：res--->",  res);
                    let ary = res.data;
                    for (let i = 0; i < ary.length; i++) {
                        ary[i].title = ary[i].name;
                    }
                    let roleStr = $("input[name='roleId']").val();
                    // console.log("ajax--roleStr-->", roleStr);
                    if (roleStr !== "") {
                        let idArys = roleStr.split(",");
                        // console.log("ajax---idArys--->", idArys);
                        // console.log("ajax---ary--->", ary);
                        let nameArys = [];
                        for (let i = 0; i < ary.length; i++) {
                            for (let j = 0; j < idArys.length; j++) {
                                if (ary[i].id === parseInt(idArys[j])) {
                                    ary[i].checked = true;
                                    // nameArys.push(ary[i].name);
                                }
                            }
                        }
                        // $("input[name='role_name']").val(nameArys.join(","));
                    }
                    initRoleTree(ary);
                },
                error: function () {
                }
            });
        }
        loadrole();
        let initRoleTree = function(roledata) {
            //常规用法
            tree.render({
                elem: '#role_tree' //默认是点击节点可进行收缩
                ,data: roledata
                ,showCheckbox: true
                ,oncheck: function(obj){
                    // console.log(obj.data); // 得到当前点击的节点数据
                    // console.log("节点是否被选中-->", obj.checked); // 节点是否被选中
                    // console.log("当前节点元素-->", obj.elem); // 得到当前节点元素
                    let roleidstr = $("input[name='roleId']").val();
                    let rolenamestr = $("input[name='role_name']").val();
                    if (obj.checked === true) {
                        let id = obj.data.id;
                        let name = obj.data.name;
                        let idAry = [];
                        if (roleidstr.length > 0) {
                            idAry = roleidstr.split(",");
                            idAry.push(id);
                        } else {
                            idAry.push(id);
                        }
                        let new_idAry = Array.from(new Set(idAry));
                        idAry = new_idAry;
                        roleidstr = idAry.join(",");
                        $("input[name='roleId']").val(roleidstr);

                        let nameAry = [];
                        if (rolenamestr.length > 0) {
                            nameAry = rolenamestr.split(",");
                            nameAry.push(name);
                        } else {
                            nameAry.push(name);
                        }
                        let new_nameAry = Array.from(new Set(nameAry));
                        nameAry = new_nameAry;
                        rolenamestr = nameAry.join(",");
                        $("input[name='role_name']").val(rolenamestr);
                    } else {
                        let id = obj.data.id;
                        let name = obj.data.name;
                        let idAry = [];
                        if (roleidstr.length > 0) {
                            idAry = roleidstr.split(",");
                            let newIdAry = [];
                            for (let i = 0; i < idAry.length; i++) {
                                if (parseInt(idAry[i]) === id) {
                                    continue;
                                }
                                newIdAry.push(idAry[i]);
                            }
                            idAry = newIdAry;
                        }

                        let new_idAry = Array.from(new Set(idAry));
                        idAry = new_idAry;
                        roleidstr = idAry.join(",");
                        $("input[name='roleId']").val(roleidstr);

                        let nameAry = [];
                        if (rolenamestr.length > 0) {
                            nameAry = rolenamestr.split(",");
                            let newNameAry = [];
                            for (let i = 0; i < nameAry.length; i++) {
                                if (nameAry[i] === name) {
                                    continue;
                                }
                                newNameAry.push(nameAry[i]);
                            }
                            nameAry = newNameAry;
                        }

                        let new_nameAry = Array.from(new Set(nameAry));
                        nameAry = new_nameAry;

                        rolenamestr = nameAry.join(",");
                        $("input[name='role_name']").val(rolenamestr);
                    }
                }
            });
            $(".layui-icon-file").hide();
        }
    });
    function setPageVal(ids) {
        $("input[name='roleId']").val(ids);
    }
    function getPage() {
        let roleids = $("input[name='roleId']").val();
        let rolenames = $("input[name='role_name']").val();

        let idAry = roleids.split(",");
        let nameAry = rolenames.split(",");

        // 去除重复项
        let new_id_ary = Array.from(new Set(idAry));
        let new_name_ary = Array.from(new Set(nameAry));
        let obj = {
            ids: new_id_ary.join(","),
            names: new_name_ary.join(",")
        };
        return JSON.stringify(obj);
    }
</script>
</html>
<style>
    /* 设置滚动条样式 */
    ::-webkit-scrollbar {
        width: 4px;
        height: 1px;
    }
    /* 设置滚动条样式 */
    ::-webkit-scrollbar-thumb {
        border-radius: 10px;
        box-shadow: inset 0 0 5px rgba(97, 184, 179, 0.1);
        background: #d5d5d5;
    }
    /* 设置滚动条样式 */
    ::-webkit-scrollbar-track {
        box-shadow: inset 0 0 5px rgba(87, 175, 187, 0.1);
        border-radius: 10px;
        background: #ffffff;
    }
</style>