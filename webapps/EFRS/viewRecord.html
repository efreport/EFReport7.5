<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8"/>
    <link rel="stylesheet" href="js/css/layui.css">
    <link rel="stylesheet" href="css/xadmin.css">
    <link rel="stylesheet" href="css/scroll.css">

    <style type="text/css">
        .layui-btn {
            background-color: #1e9fff;
        }

    </style>
</head>

<body>
<div class="x-body">
    <div class="layui-row" style="display: flex;align-items: center;justify-content: center;">
        <form class="layui-form layui-col-md12 x-so" style="height: 22px;" onsubmit="return false;">
            <input type="text" name="name" autocomplete="off" class="layui-input"
                   style="width: 150px;height:32px;line-height:32px;">
            <button type="button" id="search" class="layui-btn" data-type="reload" title="搜索"><i class="layui-icon">&#xe615;</i>
            </button>
        </form>
    </div>
    <table class="layui-hide" id="grid" lay-filter="useruv"></table>
    <script type="text/html" id="opMenuBar">
        <a class="layui-btn layui-btn-sm" lay-event="del" title="删除当前记录"><i class="layui-icon">&#xe640;</i></a>
        <a class="layui-btn layui-btn-sm" lay-event="down" title="查看当前记录"><i class="layui-icon">&#xe601;</i></a>
    </script>
</div>
</body>
<script type="text/javascript" src="js/jquery-1.11.3.min.js"></script>
<script type="text/javascript" src="js/layui.js"></script>
<script type="text/javascript">
    let table;
    let filterData = {}; //过滤条件数据
    let ip;
    let token;
    let ids = [];

    function setFilterData(data) {
        filterData = data;
    }

    function getFilterData() {
        return filterData;
    }

    function refresh() {
        layer.closeAll();
        window.location.reload();
    }


    //表格重载
    function reloadTable(data) {
        layer.closeAll();
        table.reload('grid', {
            where: {
                status: data.status,
                operator: data.operator,
                start: data.start,
                end: data.end
            }
        });
    }

    function reloadTableW() {
        table.reload('grid', {});
    }

    function initTable(templateId , curToken , curIp){ //初始化表格
        token = curToken;
        ip = curIp;
        layui.use('table', function () {
            table = layui.table;
            table.render({
                elem: '#grid',
                height: 500,
                url: ip + '/record/listRecordsByTm' + "?t=" + new Date().getTime() + '&token=' + token + '&templateId=' + templateId,
                page: true,
                cols: [[ //表头
                    {
                        field: 'id',
                        title: 'id',
                        width: 160
                    },
                    {
                        field: 'templateName',
                        title: '模板名',
                        width: 230
                    },
                    {
                        field: 'cacheTime',
                        title: '记录时间',
                        width: 210
                    },
                    {
                        field: 'paramStr',
                        title: '记录时参数',
                        width: 300
                    },
                    {
                        field: 'RIGHT',
                        title: '操作',
                        width: 220,
                        toolbar: "#opMenuBar"
                    }
                ]],
                done: function (res) {
                    //$("[data-field='ID']").css('display', 'none');
                }
            });

            table.on('tool(useruv)', function (obj) {
                var data = obj.data;
                var layEvent = obj.event;

                if (layEvent === 'del') {
                    layer.confirm('确定删除?', function (index) {
                        $.ajax({
                            url: ip + "/record/delRecord?recordId=" + data.id + "&name=" + encodeURI(data.path) + "&t=" + new Date().getTime() + "&token=" + token,
                            type: "GET",
                            success: function (resp) {
                                if (resp.state == 'success') {
                                    layer.msg("操作成功", {time: 1000}, function () {
                                        table.reload('grid', {});
                                        window.parent.initTree();
                                    });
                                } else {
                                    layer.msg(resp.text);
                                }
                            }
                        });
                    });
                } else if (layEvent === 'down') {
                    window.open(ip + '/record.html?id=' + data.id + '&token=' + token)
                }
            });

            $('#search').on('click', function () {
                filterData.name = $("input[name=name]").val();
                table.reload('grid', {
                    where: {
                        name: $("input[name=name]").val()
                    },
                    page: {
                        curr: 1 //重新从第 1 页开始
                    }
                });
            });

            $(document).on('keyup', function (event) {
                if (event.keyCode == 13) {
                    table.reload('grid', {
                        where: {
                            name: $("input[name=name]").val()
                        }
                    });
                }
            });
        });
    }




</script>
</html>